<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="MIT6-828-note-lab4, yxz的博客">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>MIT6-828-note-lab4 | yxz的博客</title>
    <link rel="icon" type="image/jpeg" href="/logo.jpg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yxz的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">yxz的博客</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/4.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">MIT6-828-note-lab4</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="container content">

    
    <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
                                <span class="chip bg-color">操作系统</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="post-category">
                                操作系统
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    4.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    29 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Lab4-note"><a href="#Lab4-note" class="headerlink" title="Lab4 note"></a>Lab4 note</h1><h2 id="1-introduction"><a href="#1-introduction" class="headerlink" title="1 introduction"></a>1 introduction</h2><p>In this lab, we should implement the preemptive multitasking mechanism among multiple simultaneously active user-mode environment. The lab is divided into 3 parts, which in each part we have disparate tasks to complete. In part A, we will add multiprocessor support to our system, while we will implement a Unix-like <code>fork</code> in part B. Ultimately, we will add support for inter-process communication (<code>IPC</code>), allowing different user-mode environments to communicate and synchronize with each other explicitly.</p>
<h2 id="2-preparation"><a href="#2-preparation" class="headerlink" title="2 preparation"></a>2 preparation</h2><p>Before starting, we are supposed to acquire some propaedeutics about multitask and multiprocessor. There are some word abbreviations about this aspect: BSP, AP, MP. Below is the explanation of them.</p>
<h3 id="2-1-operating-system-boot-up"><a href="#2-1-operating-system-boot-up" class="headerlink" title="2-1  operating system boot-up"></a>2-1  operating system boot-up</h3><p>While all processors in an MP-compliant system are functionally identical, one of the processors will be designated as the boot processor (BSP) at system initialization by system hardware or by application processors (APs). <strong>The BSP is responsible for booting the operating system.</strong> Once the MP operating system is up and running, the BSP functions as an AP. Usually a processor is designed as the BSP because it is capable of controlling all system hardware, including AP start up and shut down. The operating system must determine and remember the APIC ID of the designated BSP, so it can keep the BSP operating as the last running processor during system shut down. The BSP is not necessarily the first processor, especially in fault-tolerant MP systems in which any available processor can be designated as the BSP. There are some AP states at the time that the first instruction of the operating system is executed, while our process are in halted condition with interrupts disabled. This means that the AP’s local APICs (<code>lapic</code>) are passively monitor the APIC bus and will react only to INIT or STARTUP inter-processor interrupts (IPIs).</p>
<h3 id="2-2-AP-start-up"><a href="#2-2-AP-start-up" class="headerlink" title="2-2 AP start up"></a>2-2 AP start up</h3><p><img src="/picture/stup.png"></p>
<h2 id="3-Part-A-Multiprocessor-Support-and-Cooperative-Multitasking"><a href="#3-Part-A-Multiprocessor-Support-and-Cooperative-Multitasking" class="headerlink" title="3 Part A: Multiprocessor Support and Cooperative Multitasking"></a>3 Part A: Multiprocessor Support and Cooperative Multitasking</h2><p>There are some new include files and source files at this stage. Let’s have a look at the crucial ones.</p>
<h3 id="3-1-mmio-map-region"><a href="#3-1-mmio-map-region" class="headerlink" title="3-1 mmio_map_region"></a>3-1 <code>mmio_map_region</code></h3><p>In <code>kern/init.c</code>, we see a function called <code>lapic_init</code> and trace into it. It brings me to a source file named <code>lapic.c</code>. A variable called <code>lapicaddr</code> is initialized in <code>mpconfig.c</code>. There are three structures: <code>mp</code>, <code>mpconf</code>, <code>mpproc</code>. There are some functions related to multiprocessor:</p>
<ul>
<li><code>sum(addr, len)</code>: It’s used to check whether all the bytes memory located at the address the <code>mp</code> variable that we want to examine contains can be add up to 0.</li>
<li><code>mpsearch1(a, len)</code>: It looks for an <code>MP</code> structure in the <code>len</code> bytes at physical address <code>addr</code>.</li>
<li><code>mpsearch(void)</code>: It searches for the <code>MP</code> Floating Pointer Structure, which according to <code>[MP 4]</code> is in one of the following three locations:<ol>
<li>in the first <code>KB</code> of <code>EBDA</code></li>
<li>if there is no <code>EBDA</code>, in the first <code>KB</code> of system base memory</li>
<li>in the BIOS ROM between <code>0xE0000</code> and <code>0xFFFFF</code></li>
</ol>
</li>
<li><code>mpconfig(struct mp **pmp)</code>: It searches for an <code>MP</code> configuration table and return a pointer pointing at a <code>mpconf</code>.</li>
</ul>
<p>Above is some basic auxiliary functions. And the most significant procedure is <code>mp_init</code>. It looks for the <code>mpconfig</code> and assign the address of local APIC to <code>lapicaddr</code>. And then it initializes <code>cpus[]</code> with the aid of the configuration we read.</p>
<p>so,we get the physical address of <code>LAPIC</code>. We can map the physical address in the virtual memory so that we can access it.</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// Reserve size bytes in the MMIO region and map [pa,pa+size) at this</span>
<span class="token comment" spellcheck="true">// location.  Return the base of the reserved region.  size does *not*</span>
<span class="token comment" spellcheck="true">// have to be multiple of PGSIZE.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">mmio_map_region</span><span class="token punctuation">(</span>physaddr_t pa<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Your code here:</span>
    size <span class="token operator">=</span> <span class="token function">ROUNDUP</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>base <span class="token operator">+</span> size <span class="token operator">>=</span> MMIOLIM<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mmio_map_region: out of memory\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">boot_map_region</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> base<span class="token punctuation">,</span> size<span class="token punctuation">,</span> pa<span class="token punctuation">,</span> PTE_PCD<span class="token operator">|</span>PTE_PWT<span class="token operator">|</span>PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
    base <span class="token operator">+</span><span class="token operator">=</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3-2-modify-page-init"><a href="#3-2-modify-page-init" class="headerlink" title="3-2 modify page_init"></a>3-2 modify <code>page_init</code></h3><p><img src="/picture/3-2.png"></p>
<h3 id="3-3-mem-init-mp"><a href="#3-3-mem-init-mp" class="headerlink" title="3-3 mem_init_mp"></a>3-3 <code>mem_init_mp</code></h3><p>When writing a multiprocessor OS, it is important to distinguish between per-CPU state that is private to each processor, and global state that the whole system shares. <code>kern/cpu.h</code> defines most of the per-CPU state, including <code>struct CpuInfo</code>, which stores per-CPU variables. <code>cpunum()</code> always returns the ID of the CPU that calls it, which can be used as an index into arrays like <code>cpus</code>. Alternatively, the macro <code>thiscpu</code> is shorthand for the current CPU’s <code>struct CpuInfo</code>.</p>
<p>Here is the per-CPU state you should be aware of:</p>
<ul>
<li><p><strong>Per-CPU kernel stack</strong>.<br>Because multiple CPUs can trap into the kernel simultaneously, we need a separate kernel stack for each processor to prevent them from interfering with each other’s execution. The array <code>percpu_kstacks[NCPU][KSTKSIZE]</code> reserves space for NCPU’s worth of kernel stacks.</p>
<p>In Lab 2, you mapped the physical memory that <code>bootstack</code> refers to as the BSP’s kernel stack just below <code>KSTACKTOP</code>. Similarly, in this lab, you will map each CPU’s kernel stack into this region with guard pages acting as a buffer between them. CPU 0’s stack will still grow down from <code>KSTACKTOP</code>; CPU 1’s stack will start <code>KSTKGAP</code> bytes below the bottom of CPU 0’s stack, and so on. <code>inc/memlayout.h</code> shows the mapping layout.</p>
</li>
<li><p><strong>Per-CPU TSS and TSS descriptor</strong>.<br>A per-CPU task state segment (TSS) is also needed in order to specify where each CPU’s kernel stack lives. The TSS for CPU <em>i</em> is stored in <code>cpus[i].cpu_ts</code>, and the corresponding TSS descriptor is defined in the GDT entry <code>gdt[(GD_TSS0 &gt;&gt; 3) + i]</code>. The global <code>ts</code> variable defined in <code>kern/trap.c</code> will no longer be useful.</p>
</li>
<li><p><strong>Per-CPU current environment pointer</strong>.<br>Since each CPU can run different user process simultaneously, we redefined the symbol <code>curenv</code> to refer to <code>cpus[cpunum()].cpu_env</code> (or <code>thiscpu-&gt;cpu_env</code>), which points to the environment <em>currently</em> executing on the <em>current</em> CPU (the CPU on which the code is running).</p>
</li>
<li><p><strong>Per-CPU system registers</strong>.<br>All registers, including system registers, are private to a CPU. Therefore, instructions that initialize these registers, such as <code>lcr3()</code>, <code>ltr()</code>, <code>lgdt()</code>, <code>lidt()</code>, etc., must be executed once on each CPU. Functions <code>env_init_percpu()</code> and <code>trap_init_percpu()</code> are defined for this purpose.</p>
</li>
<li><p>In addition to this, if you have added any extra per-CPU state or performed any additional CPU-specific initialization (by say, setting new bits in the CPU registers) in your solutions to challenge problems in earlier labs, be sure to replicate them on each CPU here!</p>
</li>
</ul>
<p>We should accomplish the function <code>mem_init_mp</code>. The graph in <code>memlayout</code> illustrates the memory layout of different CPUs’ kernel stack in the virtual memory. The code is below:</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Modify mappings in kern_pgdir to support SMP</span>
<span class="token comment" spellcheck="true">//   - Map the per-CPU stacks in the region [KSTACKTOP-PTSIZE, KSTACKTOP)</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">mem_init_mp</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here:</span>
    uint32_t kstracktop_i<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NCPU<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        kstracktop_i <span class="token operator">=</span> KSTACKTOP <span class="token operator">-</span> i <span class="token operator">*</span> <span class="token punctuation">(</span>KSTKSIZE <span class="token operator">+</span> KSTKGAP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">boot_map_region</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> kstracktop_i <span class="token operator">-</span> KSTKSIZE<span class="token punctuation">,</span> 
            KSTKSIZE<span class="token punctuation">,</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>percpu_kstacks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_W<span class="token operator">|</span>PTE_P<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3-4-trap-init-per-cpu"><a href="#3-4-trap-init-per-cpu" class="headerlink" title="3-4 trap_init_per_cpu"></a>3-4 <code>trap_init_per_cpu</code></h3><p>Task segment will store for each CPU, so we shouldn’t use <code>ts</code> anymore, and replace <code>ts</code> with <code>thiscpu</code> instead.</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Initialize and load the per-CPU TSS and IDT</span>
<span class="token keyword">void</span>
<span class="token function">trap_init_percpu</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here:</span>
    <span class="token comment" spellcheck="true">// Setup a TSS so that we get the right stack</span>
    <span class="token comment" spellcheck="true">// when we trap to the kernel.</span>
    thiscpu<span class="token operator">-></span>cpu_ts<span class="token punctuation">.</span>ts_esp0 <span class="token operator">=</span> KSTACKTOP <span class="token operator">-</span> <span class="token function">cpunum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>KSTKSIZE <span class="token operator">+</span> KSTKGAP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    thiscpu<span class="token operator">-></span>cpu_ts<span class="token punctuation">.</span>ts_ss0 <span class="token operator">=</span> GD_KD<span class="token punctuation">;</span>
    thiscpu<span class="token operator">-></span>cpu_ts<span class="token punctuation">.</span>ts_iomb <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Taskstate<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Initialize the TSS slot of the gdt.</span>
    gdt<span class="token punctuation">[</span><span class="token punctuation">(</span>GD_TSS0 <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">cpunum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">SEG16</span><span class="token punctuation">(</span>STS_T32A<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>thiscpu<span class="token operator">-></span>cpu_ts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Taskstate<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gdt<span class="token punctuation">[</span><span class="token punctuation">(</span>GD_TSS0 <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">cpunum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sd_s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        
    
    <span class="token comment" spellcheck="true">// Load the TSS selector (like other segment selectors, the</span>
    <span class="token comment" spellcheck="true">// bottom three bits are special; we leave them 0)</span>
    <span class="token function">ltr</span><span class="token punctuation">(</span>GD_TSS0 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">cpunum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Load the IDT</span>
    <span class="token function">lidt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>idt_pd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3-5-scheduler"><a href="#3-5-scheduler" class="headerlink" title="3-5 scheduler"></a>3-5 <code>scheduler</code></h3><p>In the scheduler, we must choose a user environment to run and run it. The scheduler we will implement is a round-robin one. We scan the <code>envs</code> array from <code>curenv</code>. If <code>curenv</code> isn’t existing (That means there has not been a user environment yet.) ,The scanning will start from <code>envs[0]</code>. If some environment is runnable, run it!</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Choose a user environment to run and run it.</span>
<span class="token keyword">void</span>
<span class="token function">sched_yield</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>idle<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    <span class="token keyword">int</span> curid <span class="token operator">=</span> curenv <span class="token operator">?</span> <span class="token function">ENVX</span><span class="token punctuation">(</span>curenv<span class="token operator">-></span>env_id<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>curid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> NENV<span class="token punctuation">;</span> i <span class="token operator">!=</span> curid<span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> NENV<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>env_status <span class="token operator">==</span> ENV_RUNNABLE<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">env_run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>curenv<span class="token operator">-></span>env_status <span class="token operator">==</span> ENV_RUNNING<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">env_run</span><span class="token punctuation">(</span>curenv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// sched_halt never returns</span>
    <span class="token function">sched_halt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3-6-system-call"><a href="#3-6-system-call" class="headerlink" title="3-6 system call"></a>3-6 <code>system call</code></h3><p>We will provide a different, more primitive set of system calls for creating new user-mode environments. With these system calls we can implement a Unix-like <code>fork()</code> entirely in user space, in addition to other styles of environment creation. The new system calls  we need for JOS are as follows:</p>
<ul>
<li><p><code>sys_exofork</code>:</p>
<p>This system call creates a new environment with an almost blank slate: nothing is mapped in the user portion of its address space, and it is not runnable. The new environment will have the same register state as the parent environment at the time of the <code>sys_exofork</code> call. In the parent, <code>sys_exofork</code> will return the <code>envid_t</code> of the newly created environment (or a negative error code if the environment allocation failed). In the child, however, it will return 0.</p>
</li>
<li><p><code>sys_env_set_status</code>:</p>
<p>Sets the status of a specified environment to <code>ENV_RUNNABLE</code> or <code>ENV_NOT_RUNNABLE</code>. This system call is typically used to mark a new environment ready to run, once its address space and register state has been fully initialized.</p>
</li>
<li><p><code>sys_page_alloc</code>:</p>
<p>Allocates a page of physical memory and maps it at a given virtual address in a given environment’s address space.</p>
</li>
<li><p><code>sys_page_map</code>:</p>
<p>Copy a page mapping (<em>not</em> the contents of a page!) from one environment’s address space to another, leaving a memory sharing arrangement in place so that the new and the old mappings both refer to the same page of physical memory.</p>
</li>
<li><p><code>sys_page_unmap</code>: Unmap a page mapped at a given virtual address in a given environment.</p>
</li>
</ul>
<p>The description on the comments is very detailed. So I omit the details how to implement these syscalls. Here is the code:</p>
<ul>
<li><p><code>sys_exofork</code>:</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> envid_t
<span class="token function">sys_exofork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">;</span>
    <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">env_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e<span class="token punctuation">,</span> curenv<span class="token operator">-></span>env_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    e<span class="token operator">-></span>env_status <span class="token operator">=</span> ENV_NOT_RUNNABLE<span class="token punctuation">;</span>
    e<span class="token operator">-></span>env_tf <span class="token operator">=</span> curenv<span class="token operator">-></span>env_tf<span class="token punctuation">;</span>

    e<span class="token operator">-></span>env_tf<span class="token punctuation">.</span>tf_regs<span class="token punctuation">.</span>reg_eax <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>curenv<span class="token operator">-></span>env_id <span class="token operator">!=</span> e<span class="token operator">-></span>env_id<span class="token punctuation">)</span><span class="token keyword">return</span> e<span class="token operator">-></span>env_id<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//panic("sys_exofork not implemented");</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
<li><p><code>sys_env_set_status</code>:</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//    -E_INVAL if status is not a valid status for an environment.</span>
<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">sys_env_set_status</span><span class="token punctuation">(</span>envid_t envid<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">;</span>
    <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">envid2env</span><span class="token punctuation">(</span>envid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>e<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>    status <span class="token operator">!=</span> ENV_FREE <span class="token operator">&amp;&amp;</span>
        status <span class="token operator">!=</span> ENV_DYING <span class="token operator">&amp;&amp;</span>
        status <span class="token operator">!=</span> ENV_RUNNABLE <span class="token operator">&amp;&amp;</span>
        status <span class="token operator">!=</span> ENV_RUNNING <span class="token operator">&amp;&amp;</span>
        status <span class="token operator">!=</span> ENV_NOT_RUNNABLE
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>

    e<span class="token operator">-></span>env_status <span class="token operator">=</span> status<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//panic("sys_env_set_status not implemented");</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
<li><p><code>sys_page_alloc</code>:</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">sys_page_alloc</span><span class="token punctuation">(</span>envid_t envid<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">;</span>
    <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">envid2env</span><span class="token punctuation">(</span>envid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>e<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> <span class="token operator">-</span>E_BAD_ENV<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>va <span class="token operator">></span> UTOP <span class="token operator">||</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>va <span class="token operator">!=</span> <span class="token function">ROUNDUP</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>pp <span class="token operator">=</span> <span class="token function">page_alloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> <span class="token operator">-</span>E_NO_MEM<span class="token punctuation">;</span>
    <span class="token keyword">int</span> corperm <span class="token operator">=</span> PTE_P <span class="token operator">|</span> PTE_U <span class="token operator">|</span> PTE_W <span class="token operator">|</span> PTE_AVAIL<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">~</span>corperm <span class="token operator">&amp;</span> perm<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>

    res <span class="token operator">=</span> <span class="token function">page_insert</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> pp<span class="token punctuation">,</span> va<span class="token punctuation">,</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">page_free</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pp<span class="token operator">-></span>pp_ref<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//panic("sys_page_alloc not implemented");</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
<li><p><code>sys_page_map</code>:</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">sys_page_map</span><span class="token punctuation">(</span>envid_t srcenvid<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>srcva<span class="token punctuation">,</span>
         envid_t dstenvid<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dstva<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>srcenv<span class="token punctuation">,</span> <span class="token operator">*</span>dstenv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">envid2env</span><span class="token punctuation">(</span>srcenvid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>srcenv<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
        <span class="token function">envid2env</span><span class="token punctuation">(</span>dstenvid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dstenv<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_BAD_ENV<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>srcva <span class="token operator">></span> UTOP <span class="token operator">||</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>srcva <span class="token operator">!=</span> <span class="token function">ROUNDUP</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>srcva<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>
    <span class="token keyword">int</span> corperm <span class="token operator">=</span> PTE_P <span class="token operator">|</span> PTE_U <span class="token operator">|</span> PTE_W <span class="token operator">|</span> PTE_AVAIL<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">~</span>corperm <span class="token operator">&amp;</span> perm<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>

    pte_t <span class="token operator">*</span>srcpte<span class="token punctuation">,</span> <span class="token operator">*</span>dstpte<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>pp<span class="token punctuation">;</span>
    pp <span class="token operator">=</span> <span class="token function">page_lookup</span><span class="token punctuation">(</span>srcenv<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> srcva<span class="token punctuation">,</span> <span class="token operator">&amp;</span>srcpte<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>perm<span class="token operator">&amp;</span>PTE_W<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>srcpte<span class="token operator">&amp;</span>PTE_W<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>pp<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">page_insert</span><span class="token punctuation">(</span>dstenv<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> pp<span class="token punctuation">,</span> dstva<span class="token punctuation">,</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token operator">-</span>E_NO_MEM<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//panic("sys_page_map not implemented");</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
<li><p><code>sys_page_unmap</code>: </p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">sys_page_unmap</span><span class="token punctuation">(</span>envid_t envid<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">;</span>
    <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">envid2env</span><span class="token punctuation">(</span>envid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>e<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> <span class="token operator">-</span>E_BAD_ENV<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>va <span class="token operator">></span> UTOP <span class="token operator">||</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>va <span class="token operator">!=</span> <span class="token function">ROUNDUP</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>

    pte_t <span class="token operator">*</span>pte<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>pp<span class="token punctuation">;</span>
    pp <span class="token operator">=</span> <span class="token function">page_lookup</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">page_remove</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//panic("sys_page_unmap not implemented");</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
</ul>
<h2 id="4-Part-B-Copy-on-Write-Fork"><a href="#4-Part-B-Copy-on-Write-Fork" class="headerlink" title="4 Part B: Copy-on-Write Fork"></a>4 Part B: Copy-on-Write Fork</h2><p>At this part, we will implement a mechanism called Copy-on-Write, which allows the parent and child to <em>share</em> the memory mapped into their respective address spaces until one of the processes actually modifies it. When a write operation occurs, a page fault is triggered because the shared page is mapped with permission <code>read-only</code>. And then we can deal with the page fault with our methods. The concrete description is as followings:</p>
<p><strong>Copy-on-write (sometimes referred to as “<code>COW</code>“)</strong> is an optimization strategy used in computer programming. The fundamental idea is that if multiple callers ask for resources which are initially indistinguishable, you can give them pointers to the same resource. This function can be maintained until a caller tries to modify its “copy” of the resource, at which point a true private copy is created to prevent the changes becoming visible to everyone else. All of this happens transparently to the callers. The primary advantage is that if a caller never makes any modifications, no private copy need ever be created. It avoids a lot of unnecessary overhead.</p>
<p>In OS world, creating a process is a significant field of the application of <code>COW</code>. We can use <code>fork()</code> or <code>vfork()</code> to create a new process. <code>vfork</code> follows the concept of copy-on-write. For example, the child process created by <code>vfork</code> will share the data and code segment with the parent process. This speeds up the forking time. It is expected to use <code>vfork</code> if you are performing <code>exec</code> followed by <code>vfork</code>. So <code>vfork</code> will create the child process which will share data and code segment with its parent but when we call exec, it will load up the image of a new executable in the address space of the child process. In our lab, <code>fork</code> in <code>lib/fork.c</code> is so similar to <code>vfork</code>.</p>
<h3 id="4-1-sys-env-set-pgfault-upcall"><a href="#4-1-sys-env-set-pgfault-upcall" class="headerlink" title="4-1 sys_env_set_pgfault_upcall"></a>4-1 <code>sys_env_set_pgfault_upcall</code></h3><p>When a process wants to write on a page marked <code>COW</code>(with the permission <code>read-only</code>), a page fault occur. If we want to deal with the fault in user space, we should install a user page fault handler for the kernel. <code>sys_env_set_pgfault_upcall</code> is the function that install a user page fault handler. The code is below:</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">sys_env_set_pgfault_upcall</span><span class="token punctuation">(</span>envid_t envid<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">envid2env</span><span class="token punctuation">(</span>envid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>e<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token operator">-</span>E_BAD_ENV<span class="token punctuation">;</span>
    e<span class="token operator">-></span>env_pgfault_upcall <span class="token operator">=</span> func<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="4-2-page-fault-handler"><a href="#4-2-page-fault-handler" class="headerlink" title="4-2 page_fault_handler"></a>4-2 <code>page_fault_handler</code></h3><p>After installing the user page fault handler, we are supposed to modify page fault handler in kernel, make the OS run the page fault handler in user space. </p>
<ul>
<li>Set up a page fault stack frame on the user exception stack (below <code>UXSTACKTOP</code>)</li>
<li>branch to <code>curenv-&gt;env_pgfault_upcall</code></li>
<li>pay attention to dealing with the recursive case!</li>
</ul>
<p>emmm… You may have a question why we need a exception stack. In my opinion, it ensures the consistency of operations that deal with all the pages in virtual memory except user exception stack. (Maybe)</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">page_fault_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Trapframe <span class="token operator">*</span>tf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    uint32_t fault_va<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Read processor's CR2 register to find the faulting address</span>
    fault_va <span class="token operator">=</span> <span class="token function">rcr2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Handle kernel-mode page faults.</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>tf<span class="token operator">-></span>tf_cs <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"[%08x] user fault va %08x ip %08x\n"</span><span class="token punctuation">,</span>
        curenv<span class="token operator">-></span>env_id<span class="token punctuation">,</span> fault_va<span class="token punctuation">,</span> tf<span class="token operator">-></span>tf_eip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">print_trapframe</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"kernel page fault\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    <span class="token comment" spellcheck="true">// Destroy the environment that caused the fault.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>curenv<span class="token operator">-></span>env_pgfault_upcall <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//cprintf("111\n");</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"[%08x] user fault va %08x ip %08x\n"</span><span class="token punctuation">,</span>
        curenv<span class="token operator">-></span>env_id<span class="token punctuation">,</span> fault_va<span class="token punctuation">,</span> tf<span class="token operator">-></span>tf_eip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">print_trapframe</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">env_destroy</span><span class="token punctuation">(</span>curenv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    uint32_t size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> stktop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>tf<span class="token operator">-></span>tf_esp <span class="token operator">&lt;</span> UXSTACKTOP <span class="token operator">&amp;&amp;</span> tf<span class="token operator">-></span>tf_esp <span class="token operator">>=</span> UXSTACKTOP <span class="token operator">-</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">{</span>
        size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> UTrapframe<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stktop <span class="token operator">=</span> tf<span class="token operator">-></span>tf_esp<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//cprintf("%x\n",stktop - size);</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> UTrapframe<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stktop <span class="token operator">=</span> UXSTACKTOP<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//cprintf("aa %x\n",stktop - size);</span>
    <span class="token punctuation">}</span>
    <span class="token function">user_mem_assert</span><span class="token punctuation">(</span>curenv<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>stktop <span class="token operator">-</span> size<span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> PTE_U<span class="token operator">|</span>PTE_P<span class="token operator">|</span>PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">struct</span> UTrapframe <span class="token operator">*</span>utf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> UTrapframe <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>stktop <span class="token operator">-</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    utf<span class="token operator">-></span>utf_esp <span class="token operator">=</span> tf<span class="token operator">-></span>tf_esp<span class="token punctuation">;</span>
    utf<span class="token operator">-></span>utf_eflags <span class="token operator">=</span> tf<span class="token operator">-></span>tf_eflags<span class="token punctuation">;</span>
    utf<span class="token operator">-></span>utf_eip <span class="token operator">=</span> tf<span class="token operator">-></span>tf_eip<span class="token punctuation">;</span>
    utf<span class="token operator">-></span>utf_regs <span class="token operator">=</span> tf<span class="token operator">-></span>tf_regs<span class="token punctuation">;</span>
    utf<span class="token operator">-></span>utf_err <span class="token operator">=</span> tf<span class="token operator">-></span>tf_err<span class="token punctuation">;</span>
    utf<span class="token operator">-></span>utf_fault_va <span class="token operator">=</span> fault_va<span class="token punctuation">;</span>

    curenv<span class="token operator">-></span>env_tf<span class="token punctuation">.</span>tf_esp <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>utf<span class="token punctuation">;</span>
    curenv<span class="token operator">-></span>env_tf<span class="token punctuation">.</span>tf_eip <span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>curenv<span class="token operator">-></span>env_pgfault_upcall<span class="token punctuation">;</span>
    <span class="token function">env_run</span><span class="token punctuation">(</span>curenv<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<h3 id="4-3-pgfault-upcall"><a href="#4-3-pgfault-upcall" class="headerlink" title="4-3  _pgfault_upcall"></a>4-3  <code>_pgfault_upcall</code></h3><p>Now we come to the entry of user page fault handler, <code>_pgfault_upcall</code> can be seen as a scheduler of <code>_pgfault_handler</code> (the entity of user page handler). After returning from <code>_pgfault_handler</code>, there are a trap frame lying on user exception stack. We add 8 to <code>esp</code> to skip over <code>fault_va</code> and <code>error_code</code>. <code>esp</code> now points at the regular register. Because later we will <code>ret</code> to the location where the page fault occurs, we should move the <code>eip</code> to the user stack.  Then restore the trap-time registers and switch to user stack.</p>
<p><img src="/picture/utf.png"></p>
<p>Here is the code:</p>
<pre class=" language-assembly"><code class="language-assembly">.text
.globl _pgfault_upcall
_pgfault_upcall:
    // Call the C page fault handler.
    pushl %esp            // function argument: pointer to UTF
    movl _pgfault_handler, %eax
    call *%eax
    addl $4, %esp            // pop function argument
    
    //significant, move eip to the user stack in order to ret
    // LAB 4: Your code here.
    addl $8, %esp
    movl 0x20(%esp), %eax 
    movl 0x28(%esp), %ecx
    subl $4, %ecx
    movl %ecx, 0x28(%esp)
    movl %eax, (%ecx)

    // Restore the trap-time registers.  After you do this, you
    // can no longer modify any general-purpose registers.
    // LAB 4: Your code here.
    popal

    // Restore eflags from the stack.  After you do this, you can
    // no longer use arithmetic operations or anything else that
    // modifies eflags.
    // LAB 4: Your code here.
    addl $4, %esp
    popfl

    // Switch back to the adjusted trap-time stack.
    // LAB 4: Your code here.
    popl %esp

    // Return to re-execute the instruction that faulted.
    // LAB 4: Your code here.
    ret
</code></pre>
<h3 id="4-4-COW-fork"><a href="#4-4-COW-fork" class="headerlink" title="4-4 COW fork"></a>4-4 <code>COW fork</code></h3><p>Here is the code:</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">pgfault</span><span class="token punctuation">(</span><span class="token keyword">struct</span> UTrapframe <span class="token operator">*</span>utf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> utf<span class="token operator">-></span>utf_fault_va<span class="token punctuation">;</span>
    uint32_t err <span class="token operator">=</span> utf<span class="token operator">-></span>utf_err<span class="token punctuation">;</span>
    <span class="token keyword">int</span> r<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    pte_t pte <span class="token operator">=</span> uvpt<span class="token punctuation">[</span><span class="token function">PGNUM</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//cprintf("%e\n",err);</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>err<span class="token operator">&amp;</span>FEC_WR<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_COW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"%x\n"</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"pgfault: it's not a write err\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    addr <span class="token operator">=</span> <span class="token function">ROUNDDOWN</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//allocate a new page, and map it at PFTEMP</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sys_page_alloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>PFTEMP<span class="token punctuation">,</span> PTE_P<span class="token operator">|</span>PTE_W<span class="token operator">|</span>PTE_U<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"sys_page_alloc: alloc failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//move the content at virtual address addr to PFTEMP</span>
    <span class="token function">memmove</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>PFTEMP<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment" spellcheck="true">//remap the page at PFTEMP at new virtual address addr</span>
    <span class="token comment" spellcheck="true">//Here was a small bug troubling me for a long time, which I ignored PTE_W !!!</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sys_page_map</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>PFTEMP<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>addr<span class="token punctuation">,</span> PTE_W<span class="token operator">|</span>PTE_U<span class="token operator">|</span>PTE_P<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"map failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//unmap the virtual address PFTEMP</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sys_page_unmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>PFTEMP<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">duppage</span><span class="token punctuation">(</span>envid_t envid<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> pn<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> r<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>dstenv <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Env <span class="token operator">*</span><span class="token punctuation">)</span>envs <span class="token operator">+</span> <span class="token function">ENVX</span><span class="token punctuation">(</span>envid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pn <span class="token operator">*</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//the pte is certainly existing, because fork will check it.</span>
    pte_t pte <span class="token operator">=</span> uvpt<span class="token punctuation">[</span>pn<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>


    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pte<span class="token operator">&amp;</span>PTE_COW<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pte<span class="token operator">&amp;</span>PTE_W<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token function">sys_page_map</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> dstenv<span class="token operator">-></span>env_id<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> PTE_P<span class="token operator">|</span>PTE_U<span class="token operator">|</span>PTE_COW<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"sys_page_map: %e\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token function">sys_page_map</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> PTE_P<span class="token operator">|</span>PTE_U<span class="token operator">|</span>PTE_COW<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"sys_page_map: %e\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">sys_page_map</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>addr<span class="token punctuation">,</span> dstenv<span class="token operator">-></span>env_id<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> PTE_U<span class="token operator">|</span>PTE_P<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

envid_t
<span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    envid_t envid<span class="token punctuation">;</span>
    uint8_t <span class="token operator">*</span>addr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> r<span class="token punctuation">;</span>
    uint32_t pn<span class="token punctuation">;</span>

    <span class="token function">set_pgfault_handler</span><span class="token punctuation">(</span>pgfault<span class="token punctuation">)</span><span class="token punctuation">;</span>

    envid <span class="token operator">=</span> <span class="token function">sys_exofork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment" spellcheck="true">//sys_exfork returns from child </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>envid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        thisenv <span class="token operator">=</span> <span class="token operator">&amp;</span>envs<span class="token punctuation">[</span><span class="token function">ENVX</span><span class="token punctuation">(</span><span class="token function">sys_getenvid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// operate through all the page below UTOP</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>addr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>addr <span class="token operator">&lt;</span> USTACKTOP<span class="token punctuation">;</span> addr <span class="token operator">+</span><span class="token operator">=</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pn <span class="token operator">=</span> <span class="token function">PGNUM</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>PTE_P <span class="token operator">&amp;</span> uvpd<span class="token punctuation">[</span><span class="token function">PDX</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>PTE_P<span class="token operator">&amp;</span>uvpt<span class="token punctuation">[</span>pn<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        
            <span class="token function">duppage</span><span class="token punctuation">(</span>envid<span class="token punctuation">,</span> pn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// allocate a new page for UXSTACKTOP</span>
    <span class="token function">sys_page_alloc</span><span class="token punctuation">(</span>envid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>UXSTACKTOP <span class="token operator">-</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_W<span class="token operator">|</span>PTE_U<span class="token operator">|</span>PTE_P<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token function">sys_env_set_status</span><span class="token punctuation">(</span>envid<span class="token punctuation">,</span> ENV_RUNNABLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"sys_env_set_status: %e"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> envid<span class="token punctuation">;</span>

</code></pre>
<h2 id="5-Part-C-Preemptive-Multitasking-and-Inter-Process-communication-IPC"><a href="#5-Part-C-Preemptive-Multitasking-and-Inter-Process-communication-IPC" class="headerlink" title="5 Part C: Preemptive Multitasking and Inter-Process communication (IPC)"></a>5 Part C: Preemptive Multitasking and Inter-Process communication (IPC)</h2><h3 id="5-1-Preemptive-Multitasking"><a href="#5-1-Preemptive-Multitasking" class="headerlink" title="5-1 Preemptive Multitasking"></a>5-1 <code>Preemptive Multitasking</code></h3><p>In this part, we will implement preemptive multitasking, forcefully retaking control of the CPU from it. In order to achieve it, we must extend our kernel to support external hardware interrupts from the clock hardware. We should add some entries to both <code>trapentry.S</code> and <code>IDT</code>:</p>
<ul>
<li><p><code>trapentry.S</code>:</p>
<pre class=" language-c"><code class="language-c"><span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>irq_timer<span class="token punctuation">,</span> IRQ_OFFSET <span class="token operator">+</span> IRQ_TIMER<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>irq_kbd<span class="token punctuation">,</span> IRQ_OFFSET <span class="token operator">+</span> IRQ_KBD<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>irq_serial<span class="token punctuation">,</span> IRQ_OFFSET <span class="token operator">+</span> IRQ_SERIAL<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>irq_spurious<span class="token punctuation">,</span> IRQ_OFFSET <span class="token operator">+</span> IRQ_SPURIOUS<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>irq_ide<span class="token punctuation">,</span> IRQ_OFFSET <span class="token operator">+</span> IRQ_IDE<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>irq_error<span class="token punctuation">,</span> IRQ_OFFSET <span class="token operator">+</span> IRQ_ERROR<span class="token punctuation">)</span>
</code></pre>
</li>
<li><p>extend IDT in <code>trap.c</code></p>
<pre class=" language-c"><code class="language-c">    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>IRQ_OFFSET <span class="token operator">+</span> IRQ_TIMER<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> irq_timer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>IRQ_OFFSET <span class="token operator">+</span> IRQ_KBD<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> irq_kbd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>IRQ_OFFSET <span class="token operator">+</span> IRQ_SERIAL<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> irq_serial<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>IRQ_OFFSET <span class="token operator">+</span> IRQ_SPURIOUS<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> irq_spurious<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>IRQ_OFFSET <span class="token operator">+</span> IRQ_IDE<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> irq_ide<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>IRQ_OFFSET <span class="token operator">+</span> IRQ_ERROR<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> irq_error<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</li>
</ul>
<p>By now, the basic settings are done.</p>
<p>Then we make interrupt enabled in user environment. The first thing is enable interrupts while initializing an environment:</p>
<p>In <code>env_alloc</code>, we add <code>e-&gt;env_tf.tf_eflags |= FL_IF;</code> to enable interrupts, so that a user environment starts running with IF set to 1. Don’t forget to uncomment <code>'sti'</code>. Then modify the kernel’s <code>trap_dispatch()</code> function so that it calls <code>sched_yield()</code> to find and run a different environment whenever a clock interrupt takes place.</p>
<pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">// Handle clock interrupts. Don't forget to acknowledge the</span>
    <span class="token comment" spellcheck="true">// interrupt using lapic_eoi() before calling the scheduler!</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>tf<span class="token operator">-></span>tf_trapno <span class="token operator">==</span> IRQ_OFFSET <span class="token operator">+</span> IRQ_TIMER<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">lapic_eoi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sched_yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="5-2-IPC"><a href="#5-2-IPC" class="headerlink" title="5-2 IPC"></a>5-2 <code>IPC</code></h3><p>It’s enough to read the guide of this part and comments in codes to accomplish <code>IPC</code>.</p>
<p>The followings is <code>syscall</code>:</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Try to send 'value' to the target env 'envid'.</span>
<span class="token comment" spellcheck="true">// If srcva &lt; UTOP, then also send page currently mapped at 'srcva',</span>
<span class="token comment" spellcheck="true">// so that receiver gets a duplicate mapping of the same page.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// The send fails with a return value of -E_IPC_NOT_RECV if the</span>
<span class="token comment" spellcheck="true">// target is not blocked, waiting for an IPC.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// The send also can fail for the other reasons listed below.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// Otherwise, the send succeeds, and the target's ipc fields are</span>
<span class="token comment" spellcheck="true">// updated as follows:</span>
<span class="token comment" spellcheck="true">//    env_ipc_recving is set to 0 to block future sends;</span>
<span class="token comment" spellcheck="true">//    env_ipc_from is set to the sending envid;</span>
<span class="token comment" spellcheck="true">//    env_ipc_value is set to the 'value' parameter;</span>
<span class="token comment" spellcheck="true">//    env_ipc_perm is set to 'perm' if a page was transferred, 0 otherwise.</span>
<span class="token comment" spellcheck="true">// The target environment is marked runnable again, returning 0</span>
<span class="token comment" spellcheck="true">// from the paused sys_ipc_recv system call.  (Hint: does the</span>
<span class="token comment" spellcheck="true">// sys_ipc_recv function ever actually return?)</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// If the sender wants to send a page but the receiver isn't asking for one,</span>
<span class="token comment" spellcheck="true">// then no page mapping is transferred, but no error occurs.</span>
<span class="token comment" spellcheck="true">// The ipc only happens when no errors occur.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// Returns 0 on success, &lt; 0 on error.</span>
<span class="token comment" spellcheck="true">// Errors are:</span>
<span class="token comment" spellcheck="true">//    -E_BAD_ENV if environment envid doesn't currently exist.</span>
<span class="token comment" spellcheck="true">//        (No need to check permissions.)</span>
<span class="token comment" spellcheck="true">//    -E_IPC_NOT_RECV if envid is not currently blocked in sys_ipc_recv,</span>
<span class="token comment" spellcheck="true">//        or another environment managed to send first.</span>
<span class="token comment" spellcheck="true">//    -E_INVAL if srcva &lt; UTOP but srcva is not page-aligned.</span>
<span class="token comment" spellcheck="true">//    -E_INVAL if srcva &lt; UTOP and perm is inappropriate</span>
<span class="token comment" spellcheck="true">//        (see sys_page_alloc).</span>
<span class="token comment" spellcheck="true">//    -E_INVAL if srcva &lt; UTOP but srcva is not mapped in the caller's</span>
<span class="token comment" spellcheck="true">//        address space.</span>
<span class="token comment" spellcheck="true">//    -E_INVAL if (perm &amp; PTE_W), but srcva is read-only in the</span>
<span class="token comment" spellcheck="true">//        current environment's address space.</span>
<span class="token comment" spellcheck="true">//    -E_NO_MEM if there's not enough memory to map srcva in envid's</span>
<span class="token comment" spellcheck="true">//        address space.</span>
<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">sys_ipc_try_send</span><span class="token punctuation">(</span>envid_t envid<span class="token punctuation">,</span> uint32_t value<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>srcva<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> perm<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    <span class="token comment" spellcheck="true">//cprintf("send\n");</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>dstenv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">envid2env</span><span class="token punctuation">(</span>envid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dstenv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_BAD_ENV<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dstenv<span class="token operator">-></span>env_ipc_recving <span class="token operator">==</span> false<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_IPC_NOT_RECV<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>srcva <span class="token operator">&lt;</span> UTOP <span class="token operator">&amp;&amp;</span> srcva <span class="token operator">!=</span> <span class="token function">ROUNDDOWN</span><span class="token punctuation">(</span>srcva<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> corperm <span class="token operator">=</span> PTE_P <span class="token operator">|</span> PTE_U <span class="token operator">|</span> PTE_W <span class="token operator">|</span> PTE_AVAIL<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>srcva <span class="token operator">&lt;</span> UTOP <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span>corperm <span class="token operator">&amp;</span> perm<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>pp<span class="token punctuation">,</span> <span class="token operator">*</span>pp2<span class="token punctuation">;</span>
    pte_t <span class="token operator">*</span>ptep<span class="token punctuation">,</span> <span class="token operator">*</span>dstptep<span class="token punctuation">;</span>


    pp <span class="token operator">=</span> <span class="token function">page_lookup</span><span class="token punctuation">(</span>curenv<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> srcva<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ptep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>srcva <span class="token operator">&lt;</span> UTOP <span class="token operator">&amp;&amp;</span> pp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>ptep<span class="token punctuation">)</span> <span class="token operator">&amp;</span> PTE_W<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>perm <span class="token operator">&amp;</span> PTE_W<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>srcva <span class="token operator">!=</span>UTOP <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token punctuation">(</span>dstenv<span class="token operator">-></span>env_ipc_dstva<span class="token punctuation">)</span> <span class="token operator">==</span> UTOP<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>srcva <span class="token operator">!=</span> UTOP<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">envid2env</span><span class="token punctuation">(</span>envid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dstenv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>E_BAD_ENV<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        pp2 <span class="token operator">=</span> <span class="token function">page_lookup</span><span class="token punctuation">(</span>dstenv<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> srcva<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dstptep<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pp2 <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>E_NO_MEM<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">page_insert</span><span class="token punctuation">(</span>dstenv<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> pp<span class="token punctuation">,</span> dstenv<span class="token operator">-></span>env_ipc_dstva<span class="token punctuation">,</span> perm<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>E_NO_MEM<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    dstenv<span class="token operator">-></span>env_ipc_recving <span class="token operator">=</span> false<span class="token punctuation">;</span>
    dstenv<span class="token operator">-></span>env_ipc_from <span class="token operator">=</span> curenv<span class="token operator">-></span>env_id<span class="token punctuation">;</span>
    dstenv<span class="token operator">-></span>env_ipc_value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    dstenv<span class="token operator">-></span>env_ipc_perm <span class="token operator">=</span> srcva <span class="token operator">?</span> perm <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    dstenv<span class="token operator">-></span>env_status <span class="token operator">=</span> ENV_RUNNABLE<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//panic("sys_ipc_try_send not implemented");</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Block until a value is ready.  Record that you want to receive</span>
<span class="token comment" spellcheck="true">// using the env_ipc_recving and env_ipc_dstva fields of struct Env,</span>
<span class="token comment" spellcheck="true">// mark yourself not runnable, and then give up the CPU.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// If 'dstva' is &lt; UTOP, then you are willing to receive a page of data.</span>
<span class="token comment" spellcheck="true">// 'dstva' is the virtual address at which the sent page should be mapped.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// This function only returns on error, but the system call will eventually</span>
<span class="token comment" spellcheck="true">// return 0 on success.</span>
<span class="token comment" spellcheck="true">// Return &lt; 0 on error.  Errors are:</span>
<span class="token comment" spellcheck="true">//    -E_INVAL if dstva &lt; UTOP but dstva is not page-aligned.</span>
<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">sys_ipc_recv</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dstva<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    <span class="token comment" spellcheck="true">//cprintf("recv\n");</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>dstva <span class="token operator">&lt;</span> UTOP <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>dstva <span class="token operator">!=</span> <span class="token function">ROUNDDOWN</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>dstva<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    curenv<span class="token operator">-></span>env_ipc_recving<span class="token operator">=</span> true<span class="token punctuation">;</span>
    curenv<span class="token operator">-></span>env_ipc_dstva <span class="token operator">=</span> dstva<span class="token punctuation">;</span>
    curenv<span class="token operator">-></span>env_status <span class="token operator">=</span> ENV_NOT_RUNNABLE<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//cprintf("finish schedule\n");</span>
    <span class="token comment" spellcheck="true">//panic("sys_ipc_recv not implemented");</span>
    <span class="token comment" spellcheck="true">//return 0;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li><code>ipc.c</code></li>
</ul>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Receive a value via IPC and return it.</span>
<span class="token comment" spellcheck="true">// If 'pg' is nonnull, then any page sent by the sender will be mapped at</span>
<span class="token comment" spellcheck="true">//    that address.</span>
<span class="token comment" spellcheck="true">// If 'from_env_store' is nonnull, then store the IPC sender's envid in</span>
<span class="token comment" spellcheck="true">//    *from_env_store.</span>
<span class="token comment" spellcheck="true">// If 'perm_store' is nonnull, then store the IPC sender's page permission</span>
<span class="token comment" spellcheck="true">//    in *perm_store (this is nonzero iff a page was successfully</span>
<span class="token comment" spellcheck="true">//    transferred to 'pg').</span>
<span class="token comment" spellcheck="true">// If the system call fails, then store 0 in *fromenv and *perm (if</span>
<span class="token comment" spellcheck="true">//    they're nonnull) and return the error.</span>
<span class="token comment" spellcheck="true">// Otherwise, return the value sent by the sender</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// Hint:</span>
<span class="token comment" spellcheck="true">//   Use 'thisenv' to discover the value and who sent it.</span>
<span class="token comment" spellcheck="true">//   If 'pg' is null, pass sys_ipc_recv a value that it will understand</span>
<span class="token comment" spellcheck="true">//   as meaning "no page".  (Zero is not the right value, since that's</span>
<span class="token comment" spellcheck="true">//   a perfectly valid place to map a page.)</span>
int32_t
<span class="token function">ipc_recv</span><span class="token punctuation">(</span>envid_t <span class="token operator">*</span>from_env_store<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pg<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>perm_store<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    <span class="token keyword">int</span> r<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pg <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        pg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>UTOP<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//cprintf("%x\n", (uint32_t)pg);</span>
    
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        r <span class="token operator">=</span> <span class="token function">sys_ipc_recv</span><span class="token punctuation">(</span>pg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>r <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        
            <span class="token keyword">if</span><span class="token punctuation">(</span>from_env_store <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">*</span>from_env_store <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>perm_store <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">*</span>perm_store <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//cprintf("error: %e\n", r);</span>
            <span class="token keyword">return</span> r<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>thisenv<span class="token operator">-></span>env_ipc_recving <span class="token operator">==</span> false<span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>from_env_store <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token operator">*</span>from_env_store <span class="token operator">=</span> thisenv<span class="token operator">-></span>env_ipc_from<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>perm_store <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token operator">*</span>perm_store <span class="token operator">=</span> thisenv<span class="token operator">-></span>env_ipc_perm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> thisenv<span class="token operator">-></span>env_ipc_value<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//panic("ipc_recv not implemented");</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Send 'val' (and 'pg' with 'perm', if 'pg' is nonnull) to 'toenv'.</span>
<span class="token comment" spellcheck="true">// This function keeps trying until it succeeds.</span>
<span class="token comment" spellcheck="true">// It should panic() on any error other than -E_IPC_NOT_RECV.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// Hint:</span>
<span class="token comment" spellcheck="true">//   Use sys_yield() to be CPU-friendly.</span>
<span class="token comment" spellcheck="true">//   If 'pg' is null, pass sys_ipc_try_send a value that it will understand</span>
<span class="token comment" spellcheck="true">//   as meaning "no page".  (Zero is not the right value.)</span>
<span class="token keyword">void</span>
<span class="token function">ipc_send</span><span class="token punctuation">(</span>envid_t to_env<span class="token punctuation">,</span> uint32_t val<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pg<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 4: Your code here.</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pg <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        pg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>UTOP<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        r <span class="token operator">=</span> <span class="token function">sys_ipc_try_send</span><span class="token punctuation">(</span>to_env<span class="token punctuation">,</span> val<span class="token punctuation">,</span> pg<span class="token punctuation">,</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token operator">-</span>E_IPC_NOT_RECV<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"ipc_send: %e\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">sys_yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//panic("ipc_send not implemented");</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="6-Question"><a href="#6-Question" class="headerlink" title="6 Question"></a>6 Question</h2><ol>
<li><p>question: Compare <code>kern/mpentry.S</code> side by side with <code>boot/boot.S</code>. Bearing in mind that <code>kern/mpentry.S</code> is compiled and linked to run above <code>KERNBASE</code> just like everything else in the kernel, what is the purpose of macro <code>MPBOOTPHYS</code>? Why is it necessary in <code>kern/mpentry.S</code> but not in <code>boot/boot.S</code>? In other words, what could go wrong if it were omitted in <code>kern/mpentry.S</code>?</p>
<p>answer:  Below is the macro <code>MPBOOTPHYS</code>. As we know, the symbol <code>mpentry_start</code> is linked at the link address that is above <code>KERNBASE</code>, but when a <code>CPU</code> initially starts, it begins in real mode. The load address begins at <code>0x7000</code> (<code>MPENTRY_PADDR</code>), so the macro is designated for translate a link address to the corresponding load address, which allows the <code>CPU</code> can work well before turning on paging.</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> MPBOOTPHYS(s) ((s) - mpentry_start + MPENTRY_PADDR)</span>
</code></pre>
</li>
</ol>
<h2 id="7-reference"><a href="#7-reference" class="headerlink" title="7 reference"></a>7 reference</h2><ol>
<li><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2018/readings/ia32/MPspec.pdf">MultiProcessor Specification (mit.edu)</a></li>
<li>[optimization - What is copy-on-write? - Stack Overflow](<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/628938/what-is-copy-on-write#:~:text=&quot;Copy">https://stackoverflow.com/questions/628938/what-is-copy-on-write#:~:text="Copy</a> on write” means more or less what,is used to resolve concurrency sorts of problems.)</li>
<li><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2018/labs/lab4/">Lab 4: Preemptive Multitasking (mit.edu)</a></li>
</ol>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">yxz</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://changanyyy.github.io/2021/08/15/MIT6-828-note-lab4/">http://changanyyy.github.io/2021/08/15/MIT6-828-note-lab4/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">yxz</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
                                    <span class="chip bg-color">操作系统</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">您的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2021/08/15/MIT6-828-note-lab4/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="MIT6-828-note-lab4">
                        
                        <span class="card-title">MIT6-828-note-lab4</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            操作系统
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-08-15
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="post-category">
                                    操作系统
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
                        <span class="chip bg-color">操作系统</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/08/07/Software-Reliable-Method-ch3/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="Software Reliable Method ch3">
                        
                        <span class="card-title">Software Reliable Method ch3</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            软件形式化
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-08-07
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%BD%AF%E4%BB%B6%E5%BD%A2%E5%BC%8F%E5%8C%96/" class="post-category">
                                    软件形式化
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%BD%AF%E4%BB%B6%E5%BD%A2%E5%BC%8F%E5%8C%96/">
                        <span class="chip bg-color">软件形式化</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yxz的博客<br />'
            + '文章作者: yxz<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">yxz</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2019";
                    var startMonth = "6";
                    var startDate = "28";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/changanyyy" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:191220146@smail.nju.edu.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1263522794" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1263522794" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
