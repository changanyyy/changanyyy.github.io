<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="MIT6-828-note-lab3, yxz的博客">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>MIT6-828-note-lab3 | yxz的博客</title>
    <link rel="icon" type="image/jpeg" href="/logo.jpg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yxz的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">yxz的博客</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/3.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">MIT6-828-note-lab3</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="container content">

    
    <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
                                <span class="chip bg-color">操作系统</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="post-category">
                                操作系统
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    36 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Lab3-note"><a href="#Lab3-note" class="headerlink" title="Lab3 note"></a>Lab3 note</h1><h2 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1 Introduction"></a>1 Introduction</h2><p>I learned a lot in the two experiments conducted couple of days ago. Let’s look back at the previous labs. In the first lab, we were acquainted with the process of booting a computer. And in the next one, we learnt and completed a system supporting paging. On this occasion, we are supposed to complete a portion of system called processes switching. (Maybe it’s more accurate to call it environments switching?)</p>
<blockquote>
<p>Note: in this lab, the terms environment and process are interchangeable - both refer to an abstraction that allows you to run a program. We introduce the term “environment” instead of the traditional term “process” in order to stress the point that JOS environments and UNIX processes provide different interfaces, and do not provide the semantics.</p>
</blockquote>
<h2 id="2-Start-coding"><a href="#2-Start-coding" class="headerlink" title="2 Start coding"></a>2 Start coding</h2><h3 id="2-1-read-code"><a href="#2-1-read-code" class="headerlink" title="2-1 read code"></a>2-1 read code</h3><p>In this lab directory, there are much more additional source and header files. After having a quick view on these files, I have a rough idea about environments.</p>
<p>In <code>inc/env.h</code>, we can see some basic structures sustaining the abstraction of environments switching:</p>
<ol>
<li><p>we define a new variable type <code>envid_t</code>.</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> int32_t envid_t<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// An environment ID 'envid_t' has three parts:</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// +1+---------------21-----------------+--------10--------+</span>
<span class="token comment" spellcheck="true">// |0|          Uniqueifier             |   Environment    |</span>
<span class="token comment" spellcheck="true">// | |                                  |      Index       |</span>
<span class="token comment" spellcheck="true">// +------------------------------------+------------------+</span>
<span class="token comment" spellcheck="true">//                                       \--- ENVX(eid) --/</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// The environment index ENVX(eid) equals the environment's index in the</span>
<span class="token comment" spellcheck="true">// 'envs[]' array.  The uniqueifier distinguishes environments that were</span>
<span class="token comment" spellcheck="true">// created at different times, but share the same environment index.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// All real environments are greater than 0 (so the sign bit is zero).</span>
<span class="token comment" spellcheck="true">// envid_ts less than 0 signify errors.  The envid_t == 0 is special, and</span>
<span class="token comment" spellcheck="true">// stands for the current environment.</span>
</code></pre>
</li>
<li><p>And we define the maximal number of environments that concurrently run.</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> LOG2NENV        10</span>
<span class="token macro property">#<span class="token directive keyword">define</span> NENV            (1 &lt;&lt; LOG2NENV)</span>
</code></pre>
<p>As seen above, <code>NENV</code> is <code>1024 (2^10)</code>.</p>
<p>Additionally, we define a macro <code>#define ENVX(envid)        ((envid) &amp; (NENV - 1))</code>, the macro extract the <strong>INDEX</strong> portion of environment ID.</p>
</li>
<li><p>the following is a enumeration structure representing values of environment status <code>env_status</code>.</p>
<ul>
<li><code>ENV_FREE</code>: It indicates that the environment structure variable is not in use. we can feel free to allocate it to a new environment.</li>
<li><code>ENV_DYING</code>: The environment is dying, so we should free the structure variable in next dis-allocation.</li>
<li><code>ENV_RUNNABLE</code>: The environment is queuing in the scheduling queue and ready to run.</li>
<li><code>ENV_RUNNING</code>: It is the current environment.</li>
<li><code>ENV_NOT_RUNNABLE</code>: It is in blocked status, so it can’t be scheduled.</li>
</ul>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Values of env_status in struct Env</span>
<span class="token keyword">enum</span> <span class="token punctuation">{</span>
    ENV_FREE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    ENV_DYING<span class="token punctuation">,</span>
    ENV_RUNNABLE<span class="token punctuation">,</span>
    ENV_RUNNING<span class="token punctuation">,</span>
    ENV_NOT_RUNNABLE
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li><p>The enumeration <code>EnvType</code> represents the <code>env_type</code> member. This is used to distinguish special environments. For most environments,it is <code>ENV_TYPE_USER</code>. But more types in later labs.</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Special environment types</span>
<span class="token keyword">enum</span> EnvType <span class="token punctuation">{</span>
    ENV_TYPE_USER <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li><p>The most important structure is coming! <code>Env</code> plays a role as <strong>Process Control Block</strong>. </p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> Env <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> Trapframe env_tf<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Saved registers</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>env_link<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Next free Env</span>
    envid_t env_id<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// Unique environment identifier</span>
    envid_t env_parent_id<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// env_id of this env's parent</span>
    <span class="token keyword">enum</span> EnvType env_type<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Indicates special system environments</span>
    <span class="token keyword">unsigned</span> env_status<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Status of the environment</span>
    uint32_t env_runs<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Number of times environment has run</span>

    <span class="token comment" spellcheck="true">// Address space</span>
    pde_t <span class="token operator">*</span>env_pgdir<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Kernel virtual address of page dir</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>The structure has a couple of fields as above:</p>
<ol>
<li><p>The first member is a structure named <code>Trapframe</code>. It holds the saved register values for the environment while it is not running.</p>
<p><img src="/picture/trapframe.png"></p>
</li>
<li><p>The second is a pointer pointing to next free environment in the free environment list that we are going to use to allocate a new environment structure variable.</p>
</li>
<li><p><code>env_id</code>: I have explained it above. and <code>env_parent_id</code> is it’s parent’s <code>env_id</code>,for we will introduce the concept of <strong>father and son processes</strong>. All the relationships form a <strong>family tree</strong>. The kernel stores a value that uniquely identifiers the environment currently using <code>Env</code>. After a user environment terminates, the Kernel may re-allocate the same <code>Env</code> structure to a new environment that need a different <code>env_id</code> from the old one even though the new environment is re-using the same slot in the <code>env</code> array.</p>
</li>
<li><p><code>env_type</code> and <code>env_status</code>: I’ve introduced it above.</p>
</li>
<li><p><code>env_runs</code>: Numbers of times the environment has run.</p>
</li>
<li><p>The last member is <code>env_pgdir</code> which supports the virtual address memory space layout, just like <code>kern_pgdir</code>.</p>
</li>
</ol>
</li>
</ol>
<p>Above, I introduced some basic structure. But how to transform them into entities? Let’s look at the source file <code>kern/env.c</code>. There are three entities that are reflected in the eyes.</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> Env <span class="token operator">*</span>envs <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// All environments</span>
<span class="token keyword">struct</span> Env <span class="token operator">*</span>curenv <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// The current env</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> Env <span class="token operator">*</span>env_free_list<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Free environment list</span>
</code></pre>
<ul>
<li><p><code>envs</code>: The <code>envs</code> pointer points to an array of <code>Env</code> structures representing all the environments in the system. The JOS Kernel will support a maximum of <code>NENV</code> simultaneously active environments.</p>
</li>
<li><p><code>curenv</code>: This is a pointer pointing to the running environment. It is initially set to <code>NULL</code>. We use the <code>curenv</code> symbol to keep track of the currently executing environment at any given time. During boot up, before the first environment is run, <code>curenv</code> is initially set to <code>NULL</code>.</p>
</li>
<li><p><code>env_free_list</code>: This is the head pointer of free environment list , which point to the first environment structure variable that is ready to be assigned out.</p>
<ul>
<li><p>for example, if we wanna allocate a <code>env</code> for a new environment, we could do it like this: (basic for chain list)</p>
<pre class=" language-c"><code class="language-c">e <span class="token operator">=</span> env_free_list<span class="token punctuation">;</span>
env_free_list <span class="token operator">=</span> env_free_list<span class="token operator">-></span>env_link<span class="token punctuation">;</span>
</code></pre>
</li>
<li><p>Additionally, if we want to recycle a <code>env</code>:</p>
<pre class=" language-c"><code class="language-c">e<span class="token operator">-></span>env_free_list <span class="token operator">=</span> env_free_list<span class="token punctuation">;</span>
env_free_list <span class="token operator">=</span> e<span class="token punctuation">;</span>
</code></pre>
</li>
</ul>
</li>
</ul>
<p>As I said above, the include file <code>inc/env.h</code> contains basic definitions for user environments in JOS. Kernel uses the <code>Env</code> array to keep track of each user environment. In the followings, We will initially create just one environment, but later we should make the Kernel support multiple environments.</p>
<p>We couples the concepts of thread and address space. The thread is defined primarily by the saved registers, and the address space is defined by the page directory and page tables pointed to by <code>env_pgdir</code>. In order to run an environment, Kernel should set up the CPU with both the saved registers and the appropriate address space.</p>
<h3 id="2-2-Allocating-the-Environment-Array"><a href="#2-2-Allocating-the-Environment-Array" class="headerlink" title="2-2  Allocating the Environment Array"></a>2-2  Allocating the Environment Array</h3><p>Before using environment array, we should allocate space for it.</p>
<p>The work will be done in <code>mem_init</code>, which is intended for initializing memory space, opening paging mechanism, and layout for the virtual address space.</p>
<p>Just like the <code>pages</code> array, we allocate space for <code>envs</code>:</p>
<pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">//////////////////////////////////////////////////////////////////////</span>
    <span class="token comment" spellcheck="true">// Make 'envs' point to an array of size 'NENV' of 'struct Env'.</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    envs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Env <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">boot_alloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env<span class="token punctuation">)</span> <span class="token operator">*</span> NENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>And as usual, next step is of course map the array at linear address <code>UENVS</code>. </p>
<pre class=" language-c"><code class="language-c">
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token function">boot_map_region</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>UENVS<span class="token punctuation">,</span> PTSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>physaddr_t<span class="token punctuation">)</span><span class="token function">PADDR</span><span class="token punctuation">(</span>envs<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_U <span class="token operator">|</span> PTE_P<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>To test whether my code is correct, <code>make qemu</code> and find that <code>check_kern_pgdir()</code> succeeds.</p>
<h3 id="2-3-Make-the-Environment-Run"><a href="#2-3-Make-the-Environment-Run" class="headerlink" title="2-3 Make the Environment Run"></a>2-3 Make the Environment Run</h3><p>After allocating the space, we can use the <code>env</code> array to do anything. But we should get familiar with something, such as how we can load the binary image in the correct position. The guide says as below:</p>
<blockquote>
<p>The Lab 3 <code>GNUmakefile</code> generates a number of binary images in the <code>obj/user/</code> directory. If you look at <code>kern/Makefrag</code>, you will notice some magic that “links” these binaries directly into the kernel executable as if they were <code>.o</code> files. The <code>-b binary</code> option on the linker command line causes these files to be linked in as “raw” uninterpreted binary files rather than as regular <code>.o</code> files produced by the compiler. (As far as the linker is concerned, these files do not have to be ELF images at all - they could be anything, such as text files or pictures!) If you look at <code>obj/kern/kernel.sym</code> after building the kernel, you will notice that the linker has “magically” produced a number of funny symbols with obscure names like <code>_binary_obj_user_hello_start</code>, <code>_binary_obj_user_hello_end</code>, and <code>_binary_obj_user_hello_size</code>. The linker generates these symbol names by mangling the file names of the binary files; the symbols provide the regular kernel code with a way to reference the embedded binary files.</p>
</blockquote>
<p>Let’s have a look at <code>obj/kern/kernel.sym</code>, which lists all the symbols in the Kernel ELF file. So the user binary ELF files are integrated into the Kernel! So surprising! It indicates that we should read ELF files from Memory instead of disk hardware. We can operate it by <code>memcpy</code> or <code>memset</code>.</p>
<p><img src="/picture/kernsym.png"></p>
<p>First, we fill the function <code>env_init</code>. It links up all the (free) nodes in <code>envs</code>.</p>
<p>It’s usually done with the method of head interpolation. And according to the guide, the pointer <code>env_free_list</code> should point to <code>env[0]</code>. And don’t forget clear the <code>env_id</code>. </p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Mark all environments in 'envs' as free, set their env_ids to 0,</span>
<span class="token comment" spellcheck="true">// and insert them into the env_free_list.</span>
<span class="token comment" spellcheck="true">// Make sure the environments are in the free list in the same order</span>
<span class="token comment" spellcheck="true">// they are in the envs array (i.e., so that the first call to</span>
<span class="token comment" spellcheck="true">// env_alloc() returns envs[0]).</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token keyword">void</span>
<span class="token function">env_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Set up envs array</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    env_free_list <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> NENV <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>env_status <span class="token operator">=</span> ENV_FREE<span class="token punctuation">;</span>
        envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>env_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>env_link <span class="token operator">=</span> env_free_list<span class="token punctuation">;</span>
        env_free_list <span class="token operator">=</span> <span class="token operator">&amp;</span>envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Per-CPU part of the initialization</span>
    <span class="token function">env_init_percpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The function <code>env_setup_vm</code> is the second function we should fill in. It’s duty is to initialize the Kernel virtual memory layout for an environment pointed to by <code>e</code>.  The things it does is allocate a page directory, set <code>e-&gt;env_pgdir</code> accordingly, and initialize the Kernel portion of the new environment’s address space. In this stage, don’t map anything into the user portion.</p>
<p>I utilise an auxiliary function called <code>map_region</code> that has the same function as <code>boot_map_region</code>. There are four regions that we should deal with:</p>
<ol>
<li><code>UPAGES</code>: the array keeping track of physical pages</li>
<li><code>UENVS</code>: the array keeping track of active environments</li>
<li><code>KSTACK</code>: kernel stack of JOS</li>
<li><code>KERNBASE</code>: kernel data and code</li>
</ol>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">env_setup_vm</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Allocate a page for the page directory</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token function">page_alloc</span><span class="token punctuation">(</span>ALLOC_ZERO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_NO_MEM<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    p<span class="token operator">-></span>pp_ref<span class="token operator">++</span><span class="token punctuation">;</span>
    e<span class="token operator">-></span>env_pgdir <span class="token operator">=</span> <span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token function">page2pa</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">map_region</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>UPAGES<span class="token punctuation">,</span> PTSIZE<span class="token punctuation">,</span> 
        <span class="token punctuation">(</span>physaddr_t<span class="token punctuation">)</span><span class="token function">PADDR</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_U <span class="token operator">|</span> PTE_P<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">map_region</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>UENVS<span class="token punctuation">,</span> PTSIZE<span class="token punctuation">,</span> 
        <span class="token punctuation">(</span>physaddr_t<span class="token punctuation">)</span><span class="token function">PADDR</span><span class="token punctuation">(</span>envs<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_U <span class="token operator">|</span> PTE_P<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">map_region</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>KSTACKTOP <span class="token operator">-</span> KSTKSIZE<span class="token punctuation">,</span> KSTKSIZE<span class="token punctuation">,</span> 
        <span class="token punctuation">(</span>physaddr_t<span class="token punctuation">)</span><span class="token function">PADDR</span><span class="token punctuation">(</span>bootstack<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_W <span class="token operator">|</span> PTE_P<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">map_region</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>KERNBASE<span class="token punctuation">,</span> <span class="token number">0xffffffff</span> <span class="token operator">-</span> KERNBASE<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>physaddr_t<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> PTE_W <span class="token operator">|</span> PTE_P<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// UVPT maps the env's own page table read-only.</span>
    <span class="token comment" spellcheck="true">// Permissions: kernel R, user R</span>
    e<span class="token operator">-></span>env_pgdir<span class="token punctuation">[</span><span class="token function">PDX</span><span class="token punctuation">(</span>UVPT<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">)</span> <span class="token operator">|</span> PTE_P <span class="token operator">|</span> PTE_U<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The next function is <code>region_alloc</code>.  When the parameter <code>len</code> is 0 or a negative number, it’s the illegal state. Physical pages are supposed to simultaneously be mapped for <code>kern_pgdir</code> and <code>env_pgdir</code>. Another solution is <code>lcr3(e-&gt;pgdir[PDX(UVPT)])</code>, which reaches the same goal as my method.</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Allocate len bytes of physical memory for environment env,</span>
<span class="token comment" spellcheck="true">// and map it at virtual address va in the environment's address space.</span>
<span class="token comment" spellcheck="true">// Does not zero or otherwise initialize the mapped pages in any way.</span>
<span class="token comment" spellcheck="true">// Pages should be writable by user and kernel.</span>
<span class="token comment" spellcheck="true">// Panic if any allocation attempt fails.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">region_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"region_alloc: len is a negtive num\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token operator">*</span>st <span class="token operator">=</span> <span class="token function">ROUNDDOWN</span><span class="token punctuation">(</span>va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>end <span class="token operator">=</span> <span class="token function">ROUNDUP</span><span class="token punctuation">(</span>va <span class="token operator">+</span> len<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pgn <span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token punctuation">(</span>end <span class="token operator">-</span> st<span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>pg<span class="token punctuation">;</span>
    
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pgn<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        pg <span class="token operator">=</span> <span class="token function">page_alloc</span><span class="token punctuation">(</span><span class="token operator">~</span>ALLOC_ZERO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>pg<span class="token punctuation">)</span><span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"region_alloc: alloc failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pg<span class="token operator">-></span>pp_ref<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">page_insert</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> pg<span class="token punctuation">,</span> va<span class="token punctuation">,</span> PTE_W <span class="token operator">|</span> PTE_U <span class="token operator">|</span> PTE_P<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">page_insert</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> pg<span class="token punctuation">,</span> va<span class="token punctuation">,</span> PTE_W <span class="token operator">|</span> PTE_U <span class="token operator">|</span> PTE_P<span class="token punctuation">)</span><span class="token punctuation">;</span>
        va <span class="token operator">+</span><span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Having finished the previous functions, we come up with the function <code>load_icode</code>. It will load the code and data of user environment into the correct position. First, we define a variable named <code>elfhdr</code> whose type is <code>struct Elf</code> and another two variables named <code>ph</code> and <code>eph</code> pointing to the start and the end of the program header.</p>
<p>The following code assigned ELF header to <code>elfhdr</code>, and testify that it is correct:</p>
<pre class=" language-c"><code class="language-c">    <span class="token keyword">struct</span> Elf <span class="token operator">*</span>elfhdr<span class="token punctuation">;</span>
    elfhdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Elf <span class="token operator">*</span><span class="token punctuation">)</span> binary<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>elfhdr <span class="token operator">-></span> e_magic <span class="token operator">!=</span> ELF_MAGIC<span class="token punctuation">)</span><span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"load_icode: elf header error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>For further environment switching, we have to assign <code>e_entry</code> to <code>e-&gt;env_tf.tf_eip</code> so that once we switch to this environment, the register <code>eip</code> will point to the first instruction.</p>
<p>Then, we load sections through loops:</p>
<blockquote>
<p>Attention!!!</p>
<p>We should map corresponding regions before moving memory! And don’t forget to clear the memory between <code>filesz</code> and <code>memsz</code>.</p>
</blockquote>
<pre class=" language-c"><code class="language-c">    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> ph <span class="token operator">&lt;</span> eph<span class="token punctuation">;</span> ph<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//cprintf("%d",ph->p_type);</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ph<span class="token operator">-></span>p_type <span class="token operator">==</span> ELF_PROG_LOAD<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">region_alloc</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> ph<span class="token operator">-></span>p_va<span class="token punctuation">,</span> ph<span class="token operator">-></span>p_memsz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> ph<span class="token operator">-></span>p_va<span class="token punctuation">,</span> binary <span class="token operator">+</span> ph<span class="token operator">-></span>p_offset<span class="token punctuation">,</span> ph<span class="token operator">-></span>p_memsz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> ph<span class="token operator">-></span>p_va <span class="token operator">+</span> ph<span class="token operator">-></span>p_filesz<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ph<span class="token operator">-></span>p_memsz <span class="token operator">-</span> ph<span class="token operator">-></span>p_filesz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
        <span class="token punctuation">}</span>
</code></pre>
<p>In the end, we map one page for the program’s initial stack at virtual address <code>USTACKTOP-PGSIZE</code>:</p>
<pre class=" language-c"><code class="language-c">    <span class="token function">region_alloc</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> USTACKTOP <span class="token operator">-</span> PGSIZE<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The remaining two functions will integrate above all functions. But they are not difficult.</p>
<p>The first one is <code>env_create</code>:</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// Allocates a new env with env_alloc, loads the named elf</span>
<span class="token comment" spellcheck="true">// binary into it with load_icode, and sets its env_type.</span>
<span class="token comment" spellcheck="true">// This function is ONLY called during kernel initialization,</span>
<span class="token comment" spellcheck="true">// before running the first user-mode environment.</span>
<span class="token comment" spellcheck="true">// The new env's parent ID is set to 0.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token keyword">void</span>
<span class="token function">env_create</span><span class="token punctuation">(</span>uint8_t <span class="token operator">*</span>binary<span class="token punctuation">,</span> <span class="token keyword">enum</span> EnvType type<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>env_store <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token comment" spellcheck="true">//******a bug had confused me for a long time, it's because curenv is null!</span>
    <span class="token comment" spellcheck="true">//int r = env_alloc( env_store, curenv->env_id);</span>
    
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">env_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>env_store<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"env_create: env alloc failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    env_store<span class="token operator">-></span>env_type <span class="token operator">=</span> type<span class="token punctuation">;</span>
    
    <span class="token function">load_icode</span><span class="token punctuation">(</span>env_store<span class="token punctuation">,</span> binary<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The second is <code>env_run</code>. There are two steps:</p>
<p>Step1:</p>
<ol>
<li>Set the current environment (if any) back to <code>ENV_RUNNABLE</code> if it is <code>ENV_RUNNING</code>.</li>
<li>Set <code>curenv</code> to the new environment.</li>
<li>Set its status to <code>ENV_RUNNING</code>.</li>
<li>Update its <code>env_runs</code> counter.</li>
<li>Use <code>lcr3()</code> to switch to its address space.</li>
</ol>
<p>Step2:</p>
<ol>
<li>Use <code>env_pop_tf()</code> to restore the environment’s registers and drop into user mode in the environment.</li>
</ol>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">env_run</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>curenv <span class="token operator">&amp;&amp;</span> curenv<span class="token operator">-></span>env_status <span class="token operator">==</span> ENV_RUNNING<span class="token punctuation">)</span>curenv<span class="token operator">-></span>env_status <span class="token operator">=</span> ENV_RUNNABLE<span class="token punctuation">;</span>
    curenv <span class="token operator">=</span> e<span class="token punctuation">;</span>
    curenv<span class="token operator">-></span>env_status <span class="token operator">=</span> ENV_RUNNING<span class="token punctuation">;</span>
    curenv<span class="token operator">-></span>env_runs<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">lcr3</span><span class="token punctuation">(</span>curenv<span class="token operator">-></span>env_pgdir<span class="token punctuation">[</span><span class="token function">PDX</span><span class="token punctuation">(</span>UVPT<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">env_pop_tf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>curenv<span class="token operator">-></span>env_tf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"env_run not yet implemented"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="3-Test-it"><a href="#3-Test-it" class="headerlink" title="3 Test it"></a>3 Test it</h2><p>After struggle with bugs for a while, I succeed so far. Below is the screenshot when I debug with <code>GDB</code>. It crashed at the instruction <code>int $0x30</code>, which we will complete corresponding codes.</p>
<p><img src="/picture/sigtrap.png"></p>
<h2 id="4-Set-IDT"><a href="#4-Set-IDT" class="headerlink" title="4  Set IDT"></a>4  Set IDT</h2><p>From now on, we should set interrupt descriptor table correct values. But before starting, we need review some assembly instructions such as <code>int</code> and <code>iret</code>.</p>
<h3 id="4-1-INT-and-tss"><a href="#4-1-INT-and-tss" class="headerlink" title="4-1 INT and tss"></a>4-1 <code>INT</code> and <code>tss</code></h3><p>The <code>INT</code> instruction generates a call to the interrupt or exception handler specified with the destination operand. The destination operand specifies a vector from 0 to 255, encoded as an 8-bit unsigned intermediate value. Each vector provides an index to a gate descriptor in the IDT. The first 32 vector are reserved by intel for system use. Some of these vectors are used for internally generated exceptions.</p>
<p>The <code>INT n</code> instruction is the general mnemonic for executing a software generated call to an interrupt handler. The <code>INTO</code> instruction is a special mnemonic for calling overflow exception, exception 4. The overflow interrupt checks the <code>OF</code> flag in the <code>EFLAGS</code> register and calls the overflow interrupt handler if the <code>OF</code> flag is set to 1.</p>
<p>The <code>int 3</code>instruction uses a one-byte opcode(CC) and is intended for calling the debug exception handler with a breakpoint exception (#BP).</p>
<p>From i386 Documents, we find what <code>INT</code> instruction exactly does in the mode that JOS is now in:</p>
<pre class=" language-pseudocode"><code class="language-pseudocode">INTER-PRIVILEGE-LEVEL-INTERRUPT:
    (* PE = 1, interrupt or trap gate, non-conforming code segment, DPL < CPL *)
    IF (IA32_EFER.LMA = 0) (* Not IA-32e mode *)
        THEN
        (* Identify stack-segment selector for new privilege level in current TSS *)
            IF current TSS is 32-bit
                THEN
                        TSSstackAddress ← (new code-segment DPL « 3) + 4;
                        IF (TSSstackAddress + 5) > current TSS limit
                            THEN #TS(error_code(current TSS selector,0,EXT)); FI;
                            (* idt operand to error_code is 0 because selector is used *)
                        NewSS ← 2 bytes loaded from (TSS base + TSSstackAddress + 4);
                        NewESP ← 4 bytes loaded from (TSS base + TSSstackAddress);
                ELSE (* current TSS is 16-bit *)
                        TSSstackAddress ← (new code-segment DPL « 2) + 2
                        IF (TSSstackAddress + 3) > current TSS limit
                            THEN #TS(error_code(current TSS selector,0,EXT)); FI;
                            (* idt operand to error_code is 0 because selector is used *)
                        NewSS ← 2 bytes loaded from (TSS base + TSSstackAddress + 2);
                        NewESP ← 2 bytes loaded from (TSS base + TSSstackAddress);
            FI;
            IF NewSS is NULL
                THEN #TS(EXT); FI;
            IF NewSS index is not within its descriptor-table limits
            or NewSS RPL ≠ new code-segment DPL
                THEN #TS(error_code(NewSS,0,EXT)); FI;
                (* idt operand to error_code is 0 because selector is used *)
            Read new stack-segment descriptor for NewSS in GDT or LDT;
            IF new stack-segment DPL ≠ new code-segment DPL
            or new stack-segment Type does not indicate writable data segment
                THEN #TS(error_code(NewSS,0,EXT)); FI;
                (* idt operand to error_code is 0 because selector is used *)
            IF NewSS is not present
                THEN #SS(error_code(NewSS,0,EXT)); FI;
                (* idt operand to error_code is 0 because selector is used *)
</code></pre>
<p> First, the CPU will judge how many bits the TSS is, and we goes into this branch. Now, we come across a symbol called <code>TSSstackAddress</code> that represents the offset of <code>esp</code> in the TSS descriptor in this new privilege. And then the <code>ss</code> register is loaded from <code>(TSS base + TSSstackAddress + 4)</code>. The <code>esp</code> register is loaded from <code>(TSS base + TSSstackAddress)</code>. </p>
<p>Now, we are get the idea What <code>TSS</code> is. The function <code>trap_init_percpu</code> in <code>kern/trap.c</code> is helpful for us. Firstly, JOS loads assigns <code>KSTACKTOP</code> and <code>ts_ss0</code> to <code>ts.ts_esp0</code> and <code>ts.ts_ss0</code>(privilege 0). And then load the <code>TSS</code> portion of <code>gdt</code> and load the TSS selector. That’s the initializing process.</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Initialize and load the per-CPU TSS and IDT</span>
<span class="token keyword">void</span>
<span class="token function">trap_init_percpu</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Setup a TSS so that we get the right stack</span>
    <span class="token comment" spellcheck="true">// when we trap to the kernel.</span>
    ts<span class="token punctuation">.</span>ts_esp0 <span class="token operator">=</span> KSTACKTOP<span class="token punctuation">;</span>
    ts<span class="token punctuation">.</span>ts_ss0 <span class="token operator">=</span> GD_KD<span class="token punctuation">;</span>
    ts<span class="token punctuation">.</span>ts_iomb <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Taskstate<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Initialize the TSS slot of the gdt.</span>
    gdt<span class="token punctuation">[</span>GD_TSS0 <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">SEG16</span><span class="token punctuation">(</span>STS_T32A<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>ts<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Taskstate<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gdt<span class="token punctuation">[</span>GD_TSS0 <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sd_s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Load the TSS selector (like other segment selectors, the</span>
    <span class="token comment" spellcheck="true">// bottom three bits are special; we leave them 0)</span>
    <span class="token function">ltr</span><span class="token punctuation">(</span>GD_TSS0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Load the IDT</span>
    <span class="token function">lidt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>idt_pd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>And then it’s about <code>CS:EIP</code>:</p>
<pre class=" language-pseudocode"><code class="language-pseudocode"> IF IDT gate is 32-bit
        THEN
            CS:EIP ← Gate(CS:EIP); (* Segment descriptor information also loaded *)
        ELSE
            IF IDT gate 16-bit
                THEN
                        CS:IP ← Gate(CS:IP);
                        (* Segment descriptor information also loaded *)
                ELSE (* 64-bit IDT gate *)
                        CS:RIP ← Gate(CS:RIP);
                        (* Segment descriptor information also loaded *)
            FI;
</code></pre>
<p>Lastly, hardware pushes <code>EFLAGS</code> and <code>errorcode</code>…</p>
<pre class=" language-pseudocode"><code class="language-pseudocode">    IF IDT gate is 32-bit
            THEN
                Push(far pointer to old stack);
                (* Old SS and ESP, 3 words padded to 4 *)
                Push(EFLAGS);
                Push(far pointer to return instruction);
                (* Old CS and EIP, 3 words padded to 4 *)
                Push(ErrorCode); (* If needed, 4 bytes *)
</code></pre>
<p>As a summary, when the <code>INT n</code> instruction is executing, the below steps is followed.</p>
<ol>
<li>look up the <code>tr</code> register (<code>tr</code> is similar to <code>cs</code>, <code>ds</code>……) and find the correct entry in <code>gdt</code> according to the immediate number and the base address(looking up table by index!).</li>
<li><code>gdt[GD_TSS0 &gt;&gt; 3]</code> has the base address of task statement segment through which we can access <code>TSS</code>.</li>
<li>Load <code>esp0</code> and <code>ss0</code> into register <code>esp</code> and <code>ss</code>.</li>
<li>push <code>EFLAGS</code>, <code>cs</code>, <code>eip</code>, <code>errorcode</code></li>
<li>get new <code>cs</code>, <code>eip</code> from <code>IDT entry</code>.</li>
</ol>
<p>In contrast, conduct <code>iret</code> is the reverse process!</p>
<h3 id="4-2-Coding"><a href="#4-2-Coding" class="headerlink" title="4-2 Coding"></a>4-2 Coding</h3><p>We should fill the assembly file <code>trapentry.S</code>. There are two macros named <code>TRAPHANDLER</code> and <code>TRAPHANDLER_NOEC</code>. The former is used to declare a code block connected with <code>IDT</code> entries with the <code>INT</code> instruction pushing <code>errorcode</code>, and the later will explicitly push <code>0</code> as <code>errorcode</code>!</p>
<p>By looking up <a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/s09_10.htm">80386 Programmer’s Reference Manual – Section 9.10 (mit.edu)</a>, we produce code below:</p>
<pre class=" language-c"><code class="language-c"><span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>divide_entry<span class="token punctuation">,</span> T_DIVIDE<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>debug_entry<span class="token punctuation">,</span> T_DEBUG<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>nmi_entry<span class="token punctuation">,</span> T_NMI<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>brkpt_entry<span class="token punctuation">,</span> T_BRKPT<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>oflow_entry<span class="token punctuation">,</span> T_OFLOW<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>bound_entry<span class="token punctuation">,</span> T_BOUND<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>illop_entry<span class="token punctuation">,</span> T_ILLOP<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>device_entry<span class="token punctuation">,</span> T_DEVICE<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>dblflt_entry<span class="token punctuation">,</span> T_DBLFLT<span class="token punctuation">)</span>

<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>tss_entry<span class="token punctuation">,</span> T_TSS<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>segnp_entry<span class="token punctuation">,</span> T_SEGNP<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>stack_entry<span class="token punctuation">,</span> T_STACK<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>gpflt_entry<span class="token punctuation">,</span> T_GPFLT<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>pgflt_entry<span class="token punctuation">,</span> T_PGFLT<span class="token punctuation">)</span>

<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>fperr_entry<span class="token punctuation">,</span> T_FPERR<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>align_entry<span class="token punctuation">,</span> T_ALIGN<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>mchk_entry<span class="token punctuation">,</span> T_MCHK<span class="token punctuation">)</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>simderr_entry<span class="token punctuation">,</span> T_SIMDERR<span class="token punctuation">)</span>
</code></pre>
<p> All the code blocks will jump to procedure <code>_alltraps</code>, which should:</p>
<ol>
<li>push values to make the stack look like a struct <code>Trapframe</code></li>
<li>load <code>GD_KD</code> into <code>%ds</code> and <code>%es</code></li>
<li><code>pushl %esp</code> to pass a pointer to the <code>Trapframe</code> as an argument to trap()</li>
<li><code>call trap</code></li>
</ol>
<pre class=" language-assembly"><code class="language-assembly"> .global _alltraps
_alltraps:
    pushl %ds
    pushl %es
    pushal
    movl $GD_KD, %eax
    movw %ax, %ds
    movw %ax, %es
    pushl %esp
    call trap
    popal
    popl %es
    popl %ds
    addl $8, %esp
    iret
</code></pre>
<p>Don’t forget initialize trap.</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">trap_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">extern</span> <span class="token keyword">struct</span> Segdesc gdt<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_DIVIDE<span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> divide_entry<span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_DEBUG<span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> debug_entry<span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_NMI<span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> nmi_entry<span class="token punctuation">,</span>         <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_BRKPT<span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> brkpt_entry<span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_OFLOW<span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> oflow_entry<span class="token punctuation">,</span>       <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_BOUND<span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> bound_entry<span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_ILLOP<span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> illop_entry<span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_DEVICE<span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> device_entry<span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_DBLFLT<span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> dblflt_entry<span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_TSS<span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> tss_entry<span class="token punctuation">,</span>        <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_SEGNP<span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> segnp_entry<span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_STACK<span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> stack_entry<span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_GPFLT<span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> gpflt_entry<span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_PGFLT<span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> pgflt_entry<span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_FPERR<span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token number">1</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> fperr_entry<span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_ALIGN<span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token number">1</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> align_entry<span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_MCHK<span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token number">1</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> mchk_entry<span class="token punctuation">,</span>       <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_SIMDERR<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> simderr_entry<span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Per-CPU setup </span>
    <span class="token function">trap_init_percpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>That’s all in part One.</p>
<h3 id="4-3Test-part-One"><a href="#4-3Test-part-One" class="headerlink" title="4-3Test part One"></a>4-3Test part One</h3><p>Let’s <code>make grade</code>.</p>
<p><img src="/picture/makegrade.png"></p>
<h2 id="4-Episode"><a href="#4-Episode" class="headerlink" title="4 Episode"></a>4 Episode</h2><p>Let’s play an episode to take a relaxation (x) by recall the whole process how the JOS  running in. After <code>BIOS</code> initially boots up the machine, the control power is given to boot loader. </p>
<h3 id="4-1-bootloader"><a href="#4-1-bootloader" class="headerlink" title="4-1 bootloader"></a>4-1 bootloader</h3><h4 id="4-1-1-boot-S"><a href="#4-1-1-boot-S" class="headerlink" title="4-1-1 boot.S"></a>4-1-1 <code>boot.S</code></h4><h5 id="4-1-1-1-disable-interrupt-and-set-segment-register"><a href="#4-1-1-1-disable-interrupt-and-set-segment-register" class="headerlink" title="4-1-1-1 disable interrupt and set segment register"></a>4-1-1-1 disable interrupt and set segment register</h5><p>The first instruction is <code>cli</code> in physical address <code>0x7c00</code>. (Because the bios boot the bootloader at <code>0x7c00</code>.) <code>cli</code> is used to disable interrupts and the subsequent <code>cld</code> is used for string operations increment. And then the <code>start</code> clear some important data segment registers, such as <code>ds</code>, <code>es</code>, <code>ss</code>.</p>
<h5 id="4-1-1-2-enable-A20"><a href="#4-1-1-2-enable-A20" class="headerlink" title="4-1-1-2 enable A20"></a>4-1-1-2 enable A20</h5><p>Next, it enables <code>A20</code>. For backwards compatibility with the earliest PCs, physical address line 20 is tied low, so that addresses higher than <code>1MB</code> wrap around to zero by default. The code undoes this.</p>
<h5 id="4-1-1-3-switch-to-protected-mode"><a href="#4-1-1-3-switch-to-protected-mode" class="headerlink" title="4-1-1-3 switch to protected mode"></a>4-1-1-3 switch to protected mode</h5><p>The code load <code>gdtr</code> using <code>lgtr</code>. We can see that there are two segments. One is the code segment whose base address is <code>0x0</code> and limit is <code>0xffffffff</code> with permission <code>Executable</code> and <code>readable</code>. Another is the data segment whose base address is also <code>0x0</code> and limit is <code>0xffffffff</code> as well ,but with permission <code>writable</code>.</p>
<pre class=" language-assembly"><code class="language-assembly"># Bootstrap GDT
.p2align 2                                # force 4 byte alignment
gdt:
  SEG_NULL                # null seg
  SEG(STA_X|STA_R, 0x0, 0xffffffff)    # code seg
  SEG(STA_W, 0x0, 0xffffffff)            # data seg

gdtdesc:
  .word   0x17                            # sizeof(gdt) - 1
  .long   gdt                             # address gdt
</code></pre>
<p>The following is to set <code>PE</code> bit of <code>CR0</code>. It means that the system switched from real to protected mode, using a bootstrap <code>GDT</code> and segment translation that makes virtual addresses identical to their physical addresses, so that the effective memory map does not change during the switch. And instruction’s address is the same as the one before switching. The <code>ljmp</code> loads <code>PROT_MODE_DSEG</code> to <code>cs</code> and jumps to the <code>protcseg</code> procedure.</p>
<h5 id="4-1-1-4-Protcseg"><a href="#4-1-1-4-Protcseg" class="headerlink" title="4-1-1-4 Protcseg"></a>4-1-1-4 Protcseg</h5><p>It set <code>ds</code>, <code>es</code>, <code>fs</code>, <code>gs</code>, <code>ss</code> to <code>PROT_MODE_DSEG</code>. And then it makes <code>esp</code> point at <code>start</code>, which makes the space in front of <code>start</code> the temporary stack. And then call <code>bootmain</code> edited in <code>Clang</code>.</p>
<h4 id="4-1-2-bootmain"><a href="#4-1-2-bootmain" class="headerlink" title="4-1-2 bootmain"></a>4-1-2 <code>bootmain</code></h4><p><code>bootmain</code> is used to load the <code>ELF</code> into the memory. And jump to the entry by a function pointer:</p>
<pre><code>    ((void (*)(void)) (ELFHDR-&gt;e_entry))();
</code></pre>
<h3 id="4-2-Kernel"><a href="#4-2-Kernel" class="headerlink" title="4-2 Kernel"></a>4-2 Kernel</h3><h4 id="4-2-1-entry-S"><a href="#4-2-1-entry-S" class="headerlink" title="4-2-1 entry.S"></a>4-2-1 <code>entry.S</code></h4><h5 id="4-2-1-1-entry"><a href="#4-2-1-1-entry" class="headerlink" title="4-2-1-1 entry"></a>4-2-1-1 entry</h5><p>By now, we haven’t set up virtual memory yet, so we’re running from the physical address the boot loader loaded the kernel at: <code>1MB</code>. However, the C code is linked to run at <code>KERNBASE + 1MB</code>. Hence, we set up a trivial page directory that translates virtual address <code>[KERNBASE, KERNBASE + 4MB)</code> to physical addresses <code>[0, 4MB)</code>. This 4MB region will be sufficient until we set up our read page table in <code>mem_init</code>.</p>
<p>First, we load the physical address of <code>entry_pgdir</code> into <code>cr3</code>. <code>entry_pgdir</code> is defined in <code>entrypgdir.c</code>. And then turn on paging by set <code>PG</code> bit in <code>cr0</code>. Note that the subsequent two instructions’ virtual address is both in <code>[KERNBASE, KERNBASE + 4MB)</code> and <code>[0, 4MB)</code>, and we can look through <code>entrypgdir.c</code> for details. These two instructions make the low <code>eip</code> ( in<code>[0, 4MB)</code>) become in high address ( in <code>[KERNBASE, KERNBASE + 4MB)</code>), But they are both map into the same physical addresses.</p>
<h5 id="4-2-1-2-relocated"><a href="#4-2-1-2-relocated" class="headerlink" title="4-2-1-2 relocated"></a>4-2-1-2 relocated</h5><p>The procedure clear the frame pointer register <code>ebp</code> first so that the monitor’s <code>backtrace</code> can work correctly. And then it set the stack pointer <code>esp</code>. The code below is the stack region.</p>
<pre class=" language-assembly"><code class="language-assembly">.data
###################################################################
# boot stack
###################################################################
    .p2align    PGSHIFT        # force page alignment
    .globl        bootstack
bootstack:
    .space        KSTKSIZE
    .globl        bootstacktop   
bootstacktop:
</code></pre>
<p>Then, it jumps to <code>i386_init</code> in C code.</p>
<h4 id="4-2-2-i386-init"><a href="#4-2-2-i386-init" class="headerlink" title="4-2-2 i386_init"></a>4-2-2 <code>i386_init</code></h4><p>The function is intended for do some initialization. First, clear the uninitialized global data (BSS) section of our program. This ensures that all static/global variables start out zero.</p>
<h5 id="4-2-2-1"><a href="#4-2-2-1" class="headerlink" title="4-2-2-1"></a>4-2-2-1</h5><p>And then initialize the console by <code>cons_init</code>. All the functions are located in <code>console.c</code></p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// initialize the console devices</span>
<span class="token keyword">void</span>
<span class="token function">cons_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">cga_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kbd_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">serial_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serial_exists<span class="token punctuation">)</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"Serial port does not exist!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="4-2-3-pmap-c"><a href="#4-2-3-pmap-c" class="headerlink" title="4-2-3 pmap.c"></a>4-2-3 <code>pmap.c</code></h4><p>After initialization of the console, <code>mem_init</code> should enter on the stage. Firstly, it use <code>i386_detect_memory</code> to get some basic information. And then allocate space for Kernel’s page directory, and map the virtual address space. Below is the memory layout:</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
 * Virtual memory map:                                Permissions
 *                                                    kernel/user
 *
 *    4 Gig -------->  +------------------------------+
 *                     |                              | RW/--
 *                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 *                     :              .               :
 *                     :              .               :
 *                     :              .               :
 *                     |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~| RW/--
 *                     |                              | RW/--
 *                     |   Remapped Physical Memory   | RW/--
 *                     |                              | RW/--
 *    KERNBASE, ---->  +------------------------------+ 0xf0000000      --+
 *    KSTACKTOP        |     CPU0's Kernel Stack      | RW/--  KSTKSIZE   |
 *                     | - - - - - - - - - - - - - - -|                   |
 *                     |      Invalid Memory (*)      | --/--  KSTKGAP    |
 *                     +------------------------------+                   |
 *                     |     CPU1's Kernel Stack      | RW/--  KSTKSIZE   |
 *                     | - - - - - - - - - - - - - - -|                 PTSIZE
 *                     |      Invalid Memory (*)      | --/--  KSTKGAP    |
 *                     +------------------------------+                   |
 *                     :              .               :                   |
 *                     :              .               :                   |
 *    MMIOLIM ------>  +------------------------------+ 0xefc00000      --+
 *                     |       Memory-mapped I/O      | RW/--  PTSIZE
 * ULIM, MMIOBASE -->  +------------------------------+ 0xef800000
 *                     |  Cur. Page Table (User R-)   | R-/R-  PTSIZE
 *    UVPT      ---->  +------------------------------+ 0xef400000
 *                     |          RO PAGES            | R-/R-  PTSIZE
 *    UPAGES    ---->  +------------------------------+ 0xef000000
 *                     |           RO ENVS            | R-/R-  PTSIZE
 * UTOP,UENVS ------>  +------------------------------+ 0xeec00000
 * UXSTACKTOP -/       |     User Exception Stack     | RW/RW  PGSIZE
 *                     +------------------------------+ 0xeebff000
 *                     |       Empty Memory (*)       | --/--  PGSIZE
 *    USTACKTOP  --->  +------------------------------+ 0xeebfe000
 *                     |      Normal User Stack       | RW/RW  PGSIZE
 *                     +------------------------------+ 0xeebfd000
 *                     |                              |
 *                     |                              |
 *                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 *                     .                              .
 *                     .                              .
 *                     .                              .
 *                     |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|
 *                     |     Program Data &amp; Heap      |
 *    UTEXT -------->  +------------------------------+ 0x00800000
 *    PFTEMP ------->  |       Empty Memory (*)       |        PTSIZE
 *                     |                              |
 *    UTEMP -------->  +------------------------------+ 0x00400000      --+
 *                     |       Empty Memory (*)       |                   |
 *                     | - - - - - - - - - - - - - - -|                   |
 *                     |  User STAB Data (optional)   |                 PTSIZE
 *    USTABDATA ---->  +------------------------------+ 0x00200000        |
 *                     |       Empty Memory (*)       |                   |
 *    0 ------------>  +------------------------------+                 --+
 *
 * (*) Note: The kernel ensures that "Invalid Memory" is *never* mapped.
 *     "Empty Memory" is normally unmapped, but user programs may map pages
 *     there if desired.  JOS user programs map pages temporarily at UTEMP.
 */</span>
</code></pre>
<p>We allocate space for the page array and the environment array. After allocating space for all the basic structures, we initialize the page array. the first page and pages between <code>IOPHYSMEM(0x000A0000)</code> and <code>EXTPHYSMEM(0x00100000)</code> are occupied and shouldn’t be replaced or allocated anymore.</p>
<p><img src="/picture/layout.png"></p>
<p>After the initialization of physical pages, we should set up virtual memory：</p>
<ol>
<li>Map <code>pages</code> read-only by the user at linear address <code>UPAGES</code></li>
<li>Map the <code>envs</code> array read-only by the user at linear address <code>UENVS</code></li>
<li>Use the physical memory that <code>bootstack</code> refers to as the kernel stack.  The kernel stack grows down from virtual address <code>KSTACKTOP</code>. We consider the entire range from <code>[KSTACKTOP-PTSIZE, KSTACKTOP)</code> to be the kernel stack.</li>
<li>Map all of physical memory at KERNBASE. The VA range <code>[KERNBASE, 2^32)</code> should map to the PA range <code>[0, 2^32 - KERNBASE)</code>. We might not have <code>2^32 - KERNBASE</code> bytes of physical memory, but we just set up the mapping anyway.</li>
</ol>
<p>Having mapped virtual memory, we switch from the minimal entry page directory to the full <code>kern_pgdir</code> page table we just created. Our instruction pointer should be somewhere between <code>KERNBASE</code> and <code>KERNBASE + 4MB</code> right now, which is mapped the same way by both page tables.</p>
<pre class=" language-c"><code class="language-c"><span class="token function">lcr3</span><span class="token punctuation">(</span><span class="token function">PADDR</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>And then turn on all the flags of <code>cr0</code> we need.</p>
<p>Now,we finished the initialization of virtual memory layout.</p>
<h4 id="4-2-4-env-init"><a href="#4-2-4-env-init" class="headerlink" title="4-2-4 env_init"></a>4-2-4 <code>env_init</code></h4><p>We set up the environment free list by a chain. And Load new <code>GDT</code> and segment descriptors using <code>env_init_percpu</code>. Read the comments if you want more details.</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Global descriptor table.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// Set up global descriptor table (GDT) with separate segments for</span>
<span class="token comment" spellcheck="true">// kernel mode and user mode.  Segments serve many purposes on the x86.</span>
<span class="token comment" spellcheck="true">// We don't use any of their memory-mapping capabilities, but we need</span>
<span class="token comment" spellcheck="true">// them to switch privilege levels. </span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// The kernel and user segments are identical except for the DPL.</span>
<span class="token comment" spellcheck="true">// To load the SS register, the CPL must equal the DPL.  Thus,</span>
<span class="token comment" spellcheck="true">// we must duplicate the segments for the user and the kernel.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// In particular, the last argument to the SEG macro used in the</span>
<span class="token comment" spellcheck="true">// definition of gdt specifies the Descriptor Privilege Level (DPL)</span>
<span class="token comment" spellcheck="true">// of that descriptor: 0 for kernel and 3 for user.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token keyword">struct</span> Segdesc gdt<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 0x0 - unused (always faults -- for trapping NULL far pointers)</span>
    SEG_NULL<span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// 0x8 - kernel code segment</span>
    <span class="token punctuation">[</span>GD_KT <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">SEG</span><span class="token punctuation">(</span>STA_X <span class="token operator">|</span> STA_R<span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0xffffffff</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// 0x10 - kernel data segment</span>
    <span class="token punctuation">[</span>GD_KD <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">SEG</span><span class="token punctuation">(</span>STA_W<span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0xffffffff</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// 0x18 - user code segment</span>
    <span class="token punctuation">[</span>GD_UT <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">SEG</span><span class="token punctuation">(</span>STA_X <span class="token operator">|</span> STA_R<span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0xffffffff</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// 0x20 - user data segment</span>
    <span class="token punctuation">[</span>GD_UD <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">SEG</span><span class="token punctuation">(</span>STA_W<span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0xffffffff</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// 0x28 - tss, initialized in trap_init_percpu()</span>
    <span class="token punctuation">[</span>GD_TSS0 <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> SEG_NULL
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> Pseudodesc gdt_pd <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>gdt<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> gdt
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="4-2-5-trap-init"><a href="#4-2-5-trap-init" class="headerlink" title="4-2-5 trap_init"></a>4-2-5 <code>trap_init</code></h4><p>we should now have the basic information we need in order to set up the IDT and handle exceptions in JOS. For now, we will set up the IDT to handle interrupt vectors <code>0-31</code> (the processor exceptions).</p>
<p>Exceptions and interrupts are both “protected control transfers,” which cause the processor to switch from user to kernel mode (CPL=0) without giving the user-mode code any opportunity to interfere with the functioning of the kernel or other environments. In Intel’s terminology, an <em>interrupt</em> is a protected control transfer that is caused by an asynchronous event usually external to the processor, such as notification of external device I/O activity. An <em>exception</em>, in contrast, is a protected control transfer caused synchronously by the currently running code, for example due to a divide by zero or an invalid memory access.</p>
<p>In order to ensure that these protected control transfers are actually <em>protected</em>, the processor’s interrupt/exception mechanism is designed so that the code currently running when the interrupt or exception occurs <em>does not get to choose arbitrarily where the kernel is entered or how</em>. Instead, the processor ensures that the kernel can be entered only under carefully controlled conditions. On the x86, two mechanisms work together to provide this protection:</p>
<ol>
<li><p><strong>The Interrupt Descriptor Table.</strong> The processor ensures that interrupts and exceptions can only cause the kernel to be entered at a few specific, well-defined entry-points <em>determined by the kernel itself</em>, and not by the code running when the interrupt or exception is taken.</p>
<p>The x86 allows up to 256 different interrupt or exception entry points into the kernel, each with a different <em>interrupt vector</em>. A vector is a number between 0 and 255. An interrupt’s vector is determined by the source of the interrupt: different devices, error conditions, and application requests to the kernel generate interrupts with different vectors. The CPU uses the vector as an index into the processor’s <em>interrupt descriptor table</em> (IDT), which the kernel sets up in kernel-private memory, much like the GDT. From the appropriate entry in this table the processor loads:</p>
<ul>
<li>the value to load into the instruction pointer (<code>EIP</code>) register, pointing to the kernel code designated to handle that type of exception.</li>
<li>the value to load into the code segment (<code>CS</code>) register, which includes in bits 0-1 the privilege level at which the exception handler is to run. (In JOS, all exceptions are handled in kernel mode, privilege level 0.)</li>
</ul>
</li>
<li><p><strong>The Task State Segment.</strong> The processor needs a place to save the <em>old</em> processor state before the interrupt or exception occurred, such as the original values of <code>EIP</code> and <code>CS</code> before the processor invoked the exception handler, so that the exception handler can later restore that old state and resume the interrupted code from where it left off. But this save area for the old processor state must in turn be protected from unprivileged user-mode code; otherwise buggy or malicious user code could compromise the kernel.</p>
<p>For this reason, when an x86 processor takes an interrupt or trap that causes a privilege level change from user to kernel mode, it also switches to a stack in the kernel’s memory. A structure called the <em>task state segment</em> (TSS) specifies the segment selector and address where this stack lives. The processor pushes (on this new stack) <code>SS</code>, <code>ESP</code>, <code>EFLAGS</code>, <code>CS</code>, <code>EIP</code>, and an optional error code. Then it loads the <code>CS</code> and <code>EIP</code> from the interrupt descriptor, and sets the <code>ESP</code> and <code>SS</code> to refer to the new stack.</p>
<p>Although the TSS is large and can potentially serve a variety of purposes, JOS only uses it to define the kernel stack that the processor should switch to when it transfers from user to kernel mode. Since “kernel mode” in JOS is privilege level 0 on the x86, the processor uses the <code>ESP0</code> and <code>SS0</code> fields of the TSS to define the kernel stack when entering kernel mode. JOS doesn’t use any other TSS fields.</p>
</li>
</ol>
<p>There is an example in the <a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2018/labs/lab3/#An-Example">lab guide</a>. And for more details, please refer to the <strong>reference 7</strong>. </p>
<h4 id="4-2-6-Create-a-user-environment"><a href="#4-2-6-Create-a-user-environment" class="headerlink" title="4-2-6 Create a user environment"></a>4-2-6 <code>Create a user environment</code></h4><p>All preparatory work is done, so we can create a user environment. </p>
<h5 id="4-2-6-1-a-macro"><a href="#4-2-6-1-a-macro" class="headerlink" title="4-2-6-1 a macro"></a>4-2-6-1 <code>a macro</code></h5><p>macro <code>ENV_CREATE(x, type)</code> is used for sticking the string together and call <code>env_create</code>. </p>
<h5 id="4-2-6-2-env-create"><a href="#4-2-6-2-env-create" class="headerlink" title="4-2-6-2 env_create"></a>4-2-6-2 <code>env_create</code></h5><p>it allocates a <code>env</code> structure for the user environment first. And load its ELF file into the memory. (In fact, it move it from kernel text to another position.) </p>
<h5 id="4-2-6-3-load-icode"><a href="#4-2-6-3-load-icode" class="headerlink" title="4-2-6-3 load_icode"></a>4-2-6-3 <code>load_icode</code></h5><p>Its duty is to move the loadable section to the correct location. The detail is in the code!</p>
<h5 id="4-2-6-4-env-run"><a href="#4-2-6-4-env-run" class="headerlink" title="4-2-6-4 env_run"></a>4-2-6-4 <code>env_run</code></h5><p>It loads the page directory’s base address into <code>cr3</code>. And change the state of the environment. Then pop the registers and conduct <code>iret</code>.</p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><ol>
<li><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/s09_10.htm">80386 Programmer’s Reference Manual – Section 9.10 (mit.edu)</a></li>
<li><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/s09_09.htm">80386 Programmer’s Reference Manual – Section 9.9 (mit.edu)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/elv/article/details/4140532">实模式、保护模式、虚拟8086模式和IA-32e模式_elv的专栏-CSDN博客</a></li>
<li><a target="_blank" rel="noopener" href="https://www.felixcloutier.com/x86/intn:into:int3:int1">INT n/INTO/INT3/INT1 — Call to Interrupt Procedure (felixcloutier.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/s09_06.htm">80386 Programmer’s Reference Manual – Section 9.6 (mit.edu)</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3425085/the-difference-between-call-gate-interrupt-gate-trap-gate">x86 - The difference between Call Gate, Interrupt Gate, Trap Gate? - Stack Overflow</a></li>
<li>《计算机系统基础》（第二版）（袁春风）</li>
</ol>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">yxz</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://changanyyy.github.io/2021/07/31/MIT6-828-note-lab3/">http://changanyyy.github.io/2021/07/31/MIT6-828-note-lab3/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">yxz</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
                                    <span class="chip bg-color">操作系统</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">您的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/08/07/Software-Reliable-Method-ch3/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="Software Reliable Method ch3">
                        
                        <span class="card-title">Software Reliable Method ch3</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            软件形式化
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-08-07
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%BD%AF%E4%BB%B6%E5%BD%A2%E5%BC%8F%E5%8C%96/" class="post-category">
                                    软件形式化
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%BD%AF%E4%BB%B6%E5%BD%A2%E5%BC%8F%E5%8C%96/">
                        <span class="chip bg-color">软件形式化</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/07/19/MIT6-828-note-lab2/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="MIT6-828-note-lab2">
                        
                        <span class="card-title">MIT6-828-note-lab2</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            操作系统
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="post-category">
                                    操作系统
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
                        <span class="chip bg-color">操作系统</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yxz的博客<br />'
            + '文章作者: yxz<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">yxz</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2019";
                    var startMonth = "6";
                    var startDate = "28";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/changanyyy" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:191220146@smail.nju.edu.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1263522794" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1263522794" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
